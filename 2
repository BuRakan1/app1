    def _create_courses_tab(self):
        """Ø¥Ù†Ø´Ø§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„"""
        courses_frame = tk.Frame(self.tab_control, bg=self.COLORS["background"])
        self.tab_control.add(courses_frame, text="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„")

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
        header_frame = tk.Frame(courses_frame, bg="#1E3A5F", height=80)
        header_frame.pack(fill=tk.X, padx=10, pady=10)
        header_frame.pack_propagate(False)

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
        title_label = tk.Label(
            header_frame,
            text="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©",
            font=self.FONTS["large_title"],
            bg="#1E3A5F",
            fg="white"
        )
        title_label.pack(side=tk.LEFT, padx=20, pady=20)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        buttons_frame = tk.Frame(header_frame, bg="#1E3A5F")
        buttons_frame.pack(side=tk.RIGHT, padx=20, pady=20)

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¨ØªØ±ØªÙŠØ¨ Ù…Ù†Ø·Ù‚ÙŠ
        buttons = [
            ("Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª", self.COLORS["primary"], self._manage_course_names),
            ("ØªØ¹ÙŠÙŠÙ† Ù…Ø¯Ø±Ø³ÙŠÙ† Ù„Ù„Ø¯ÙˆØ±Ø§Øª", "#17a2b8", self._manage_course_teachers_paths),
            ("ØªÙ†ÙÙŠØ° Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¬Ø¯ÙŠØ¯", self.COLORS["success"], self._add_training_program),
            ("ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬", self.COLORS["warning"], self._edit_training_program),
            ("Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", "#6f42c1", self._archive_selected_program),
            ("Ø­Ø°Ù Ø¨Ø±Ù†Ø§Ù…Ø¬", self.COLORS["danger"], self._delete_training_program)
        ]

        for text, color, command in buttons:
            btn = tk.Button(
                buttons_frame,
                text=text,
                font=self.FONTS["text_bold"],
                bg=color,
                fg="white",
                padx=20,
                pady=10,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=command
            )
            btn.pack(side=tk.LEFT, padx=5)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø­Ø«
        search_frame = tk.Frame(courses_frame, bg=self.COLORS["surface"], height=60)
        search_frame.pack(fill=tk.X, padx=15, pady=(10, 5))
        search_frame.pack_propagate(False)

        # Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø­Ø«
        search_container = tk.Frame(search_frame, bg=self.COLORS["surface"])
        search_container.pack(side=tk.LEFT, padx=20, pady=15)

        tk.Label(
            search_container,
            text="Ø¨Ø­Ø«:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["surface"]
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.program_search_entry = tk.Entry(
            search_container,
            font=self.FONTS["text"],
            width=30
        )
        self.program_search_entry.pack(side=tk.LEFT)
        self.program_search_entry.bind('<KeyRelease>', lambda e: self._search_programs())

        tk.Label(
            search_container,
            text="(Ø±Ù‚Ù… Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬)",
            font=self.FONTS["small"],
            bg=self.COLORS["surface"],
            fg="#666"
        ).pack(side=tk.LEFT, padx=(10, 0))

        # Ø®Ø· ÙØ§ØµÙ„
        separator = tk.Frame(courses_frame, bg=self.COLORS["border"], height=2)
        separator.pack(fill=tk.X, padx=15, pady=(0, 10))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        main_table_frame = tk.Frame(courses_frame, bg="#FFFFFF", bd=2, relief=tk.RIDGE)
        main_table_frame.pack(fill=tk.BOTH, expand=True, padx=15, pady=(0, 10))

        # Ø¥Ø·Ø§Ø± Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ø¬Ø¯ÙˆÙ„
        table_frame = tk.Frame(main_table_frame, bg="#FFFFFF")
        table_frame.pack(fill=tk.BOTH, expand=True, padx=3, pady=3)

        # Ø¥Ù†Ø´Ø§Ø¡ Treeview Ø¨ØªØµÙ…ÙŠÙ… Ø±Ø³Ù…ÙŠ
        style = ttk.Style()

        # ØªÙƒÙˆÙŠÙ† Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙˆÙ„
        style.configure("Programs.Treeview",
                        background="#FFFFFF",
                        foreground="#000000",
                        rowheight=45,
                        fieldbackground="#FFFFFF",
                        font=("Tajawal", 14, "normal"),
                        borderwidth=1,
                        relief="solid")

        # ØªÙƒÙˆÙŠÙ† Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        style.configure("Programs.Treeview.Heading",
                        font=("Tajawal", 16, "bold"),
                        background="#1E3A5F",
                        foreground="#FFFFFF",
                        relief="raised",
                        borderwidth=1,
                        padding=[10, 8])

        # Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ
        v_scrollbar = ttk.Scrollbar(table_frame, orient="vertical")
        v_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        self.programs_tree = ttk.Treeview(
            table_frame,
            columns=("number", "name", "start_date", "end_date", "category", "subjects"),
            show="tree headings",
            style="Programs.Treeview",
            yscrollcommand=v_scrollbar.set,
            height=10
        )

        # Ø¥Ø®ÙØ§Ø¡ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø´Ø¬Ø±Ø©
        self.programs_tree.column("#0", width=0, stretch=tk.NO)

        # ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        column_configs = [
            ("number", "Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", 150, tk.CENTER),
            ("name", "Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", 300, tk.CENTER),
            ("start_date", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", 120, tk.CENTER),
            ("end_date", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", 120, tk.CENTER),
            ("category", "Ø§Ù„ÙØ¦Ø©", 150, tk.CENTER),
            ("subjects", "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯", 100, tk.CENTER)
        ]

        for col_id, heading, width, anchor in column_configs:
            self.programs_tree.column(col_id, width=width, anchor=anchor)
            self.programs_tree.heading(col_id, text=heading, anchor=tk.CENTER)

        # ØªÙƒÙˆÙŠÙ† Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØµÙÙˆÙ
        self.programs_tree.tag_configure('oddrow', background='#FFFFFF')
        self.programs_tree.tag_configure('evenrow', background='#F0F8FF')

        self.programs_tree.pack(fill=tk.BOTH, expand=True)
        v_scrollbar.config(command=self.programs_tree.yview)

        # Ø±Ø¨Ø· Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
        self.programs_tree.bind("<Double-Button-1>", self._show_program_details)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠ
        info_frame = tk.Frame(courses_frame, bg="#1E3A5F", height=60)
        info_frame.pack(fill=tk.X, padx=15, pady=(5, 10))
        info_frame.pack_propagate(False)

        # Ø®Ø· ÙØ§ØµÙ„ Ø¹Ù„ÙˆÙŠ
        separator = tk.Frame(info_frame, bg="#FFFFFF", height=2)
        separator.pack(fill=tk.X)

        # Ø¥Ø·Ø§Ø± Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        inner_info = tk.Frame(info_frame, bg="#1E3A5F")
        inner_info.pack(expand=True)

        self.program_count_label = tk.Label(
            inner_info,
            text="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©: 0",
            font=("Tajawal", 14, "bold"),
            bg="#1E3A5F",
            fg="#FFFFFF"
        )
        self.program_count_label.pack(pady=15)

        # ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬
        self._load_training_programs()

    def _create_archive_tab(self):
        """Ø¥Ù†Ø´Ø§Ø¡ ØªØ¨ÙˆÙŠØ¨ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬"""
        archive_frame = tk.Frame(self.tab_control, bg=self.COLORS["background"])
        self.tab_control.add(archive_frame, text="Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬")

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† - Ø¨Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø³Ù…ÙŠ
        header_frame = tk.Frame(archive_frame, bg="#1E3A5F", height=80)
        header_frame.pack(fill=tk.X, padx=10, pady=10)
        header_frame.pack_propagate(False)

        title_label = tk.Label(
            header_frame,
            text="Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©",
            font=self.FONTS["large_title"],
            bg="#1E3A5F",
            fg="white"
        )
        title_label.pack(side=tk.LEFT, padx=20, pady=20)

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ±
        export_buttons_frame = tk.Frame(header_frame, bg="#1E3A5F")
        export_buttons_frame.pack(side=tk.RIGHT, padx=20, pady=20)

        tk.Button(
            export_buttons_frame,
            text="ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒÙ„ Excel",
            font=self.FONTS["text_bold"],
            bg="#28a745",
            fg="white",
            padx=20,
            pady=10,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._export_all_archive()
        ).pack(side=tk.LEFT, padx=5)

        tk.Button(
            export_buttons_frame,
            text="ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø­Ø¯Ø¯ Excel",
            font=self.FONTS["text_bold"],
            bg="#17a2b8",
            fg="white",
            padx=20,
            pady=10,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._export_selected_archive()
        ).pack(side=tk.LEFT, padx=5)

        tk.Button(
            export_buttons_frame,
            text="Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
            font=self.FONTS["text_bold"],
            bg="#ffc107",
            fg="white",
            padx=20,
            pady=10,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._restore_archived_program()
        ).pack(side=tk.LEFT, padx=5)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
        search_frame = tk.Frame(archive_frame, bg=self.COLORS["surface"], height=120)
        search_frame.pack(fill=tk.X, padx=15, pady=(10, 5))
        search_frame.pack_propagate(False)

        search_container = tk.Frame(search_frame, bg=self.COLORS["surface"])
        search_container.pack(fill=tk.BOTH, expand=True, padx=20, pady=15)

        # Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ - Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
        row1 = tk.Frame(search_container, bg=self.COLORS["surface"])
        row1.pack(fill=tk.X, pady=(0, 10))

        tk.Label(
            row1,
            text="Ø¨Ø­Ø«:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["surface"]
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.archive_search_entry = tk.Entry(
            row1,
            font=self.FONTS["text"],
            width=40
        )
        self.archive_search_entry.pack(side=tk.LEFT, padx=(0, 10))
        self.archive_search_entry.bind('<KeyRelease>', lambda e: self._search_archive())

        tk.Label(
            row1,
            text="(Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŒ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©ØŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³)",
            font=self.FONTS["small"],
            bg=self.COLORS["surface"],
            fg="#666"
        ).pack(side=tk.LEFT)

        # Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ - Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®
        row2 = tk.Frame(search_container, bg=self.COLORS["surface"])
        row2.pack(fill=tk.X)

        tk.Label(
            row2,
            text="Ù…Ù† ØªØ§Ø±ÙŠØ®:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["surface"]
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.archive_from_date = DateEntry(
            row2,
            font=self.FONTS["text"],
            date_pattern='yyyy-mm-dd',
            width=12
        )
        self.archive_from_date.pack(side=tk.LEFT, padx=(0, 20))

        tk.Label(
            row2,
            text="Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["surface"]
        ).pack(side=tk.LEFT, padx=(0, 10))

        self.archive_to_date = DateEntry(
            row2,
            font=self.FONTS["text"],
            date_pattern='yyyy-mm-dd',
            width=12
        )
        self.archive_to_date.pack(side=tk.LEFT, padx=(0, 10))

        tk.Button(
            row2,
            text="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["primary"],
            fg="white",
            padx=15,
            pady=5,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self._search_archive_by_date
        ).pack(side=tk.LEFT, padx=10)

        tk.Button(
            row2,
            text="Ù…Ø³Ø­ Ø§Ù„ÙÙ„ØªØ±",
            font=self.FONTS["text"],
            bg="#6c757d",
            fg="white",
            padx=15,
            pady=5,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self._clear_archive_filters
        ).pack(side=tk.LEFT)

        # Ø®Ø· ÙØ§ØµÙ„
        separator = tk.Frame(archive_frame, bg=self.COLORS["border"], height=2)
        separator.pack(fill=tk.X, padx=15, pady=(0, 10))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
        table_frame = tk.Frame(archive_frame, bg="#FFFFFF", bd=2, relief=tk.RIDGE)
        table_frame.pack(fill=tk.BOTH, expand=True, padx=15, pady=(0, 10))

        inner_table = tk.Frame(table_frame, bg="#FFFFFF")
        inner_table.pack(fill=tk.BOTH, expand=True, padx=3, pady=3)

        # Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ±
        scrollbar = ttk.Scrollbar(inner_table, orient="vertical")
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
        self.archive_tree = ttk.Treeview(
            inner_table,
            columns=("number", "name", "start_date", "end_date", "category", "archived_date", "teachers"),
            show="tree headings",
            style="Programs.Treeview",
            yscrollcommand=scrollbar.set,
            height=10
        )

        self.archive_tree.column("#0", width=0, stretch=tk.NO)

        columns = [
            ("number", "Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", 120, tk.CENTER),
            ("name", "Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©", 250, tk.CENTER),
            ("start_date", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©", 100, tk.CENTER),
            ("end_date", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©", 100, tk.CENTER),
            ("category", "Ø§Ù„ÙØ¦Ø©", 100, tk.CENTER),
            ("archived_date", "ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©", 120, tk.CENTER),
            ("teachers", "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†", 100, tk.CENTER)
        ]

        for col_id, heading, width, anchor in columns:
            self.archive_tree.column(col_id, width=width, anchor=anchor)
            self.archive_tree.heading(col_id, text=heading, anchor=tk.CENTER)

        self.archive_tree.pack(fill=tk.BOTH, expand=True)
        scrollbar.config(command=self.archive_tree.yview)

        # Ø±Ø¨Ø· Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        self.archive_tree.bind("<Double-Button-1>", self._show_archived_program_details)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        info_frame = tk.Frame(archive_frame, bg="#1E3A5F", height=60)
        info_frame.pack(fill=tk.X, padx=15, pady=(5, 10))
        info_frame.pack_propagate(False)

        self.archive_count_label = tk.Label(
            info_frame,
            text="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©: 0",
            font=("Tajawal", 14, "bold"),
            bg="#1E3A5F",
            fg="#FFFFFF"
        )
        self.archive_count_label.pack(expand=True)

        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©
        self._load_archived_programs()

    def _load_archived_programs(self):
        """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©"""
        for item in self.archive_tree.get_children():
            self.archive_tree.delete(item)

        try:
            cursor = self.db_conn.cursor()

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
            cursor.execute("PRAGMA table_info(training_programs)")
            columns = [column[1] for column in cursor.fetchall()]

            has_is_archived = 'is_archived' in columns
            has_archived_date = 'archived_date' in columns

            if has_is_archived:
                # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©
                if has_archived_date:
                    cursor.execute("""
                        SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                               tp.end_date, tp.category, tp.archived_date,
                               (SELECT COUNT(DISTINCT ps.teacher_id) 
                                FROM program_schedule ps 
                                WHERE ps.program_id = tp.id AND ps.teacher_id IS NOT NULL) as teacher_count
                        FROM training_programs tp
                        LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                        WHERE tp.is_archived = 1
                        ORDER BY tp.archived_date DESC
                    """)
                else:
                    cursor.execute("""
                        SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                               tp.end_date, tp.category, 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯' as archived_date,
                               (SELECT COUNT(DISTINCT ps.teacher_id) 
                                FROM program_schedule ps 
                                WHERE ps.program_id = tp.id AND ps.teacher_id IS NOT NULL) as teacher_count
                        FROM training_programs tp
                        LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                        WHERE tp.is_archived = 1
                        ORDER BY tp.start_date DESC
                    """)

                programs = cursor.fetchall()

                for index, program in enumerate(programs):
                    display_data = program[1:]  # ØªØ®Ø·ÙŠ id
                    tag = 'evenrow' if index % 2 == 0 else 'oddrow'
                    self.archive_tree.insert("", tk.END, values=display_data,
                                             tags=(tag, f"id_{program[0]}"))

                self.archive_count_label.config(text=f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©: {len(programs)}")
            else:
                # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£Ø±Ø´ÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø©
                self.archive_count_label.config(text="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±Ø§Ù…Ø¬ Ù…Ø¤Ø±Ø´ÙØ© (Ø§Ù„Ø¹Ù…ÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯)")

                # Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                try:
                    cursor.execute("ALTER TABLE training_programs ADD COLUMN is_archived INTEGER DEFAULT 0")
                    cursor.execute("ALTER TABLE training_programs ADD COLUMN archived_date TEXT")
                    self.db_conn.commit()
                    messagebox.showinfo("ØªØ­Ø¯ÙŠØ«", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙØ©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬.")
                except:
                    pass

        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©: {e}")
            self.archive_count_label.config(text="Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©")

    def _search_archive(self):
        """Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ"""
        search_text = self.archive_search_entry.get().strip()

        for item in self.archive_tree.get_children():
            self.archive_tree.delete(item)

        try:
            cursor = self.db_conn.cursor()

            if search_text:
                # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆØ§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³
                cursor.execute("""
                    SELECT DISTINCT tp.id, tp.program_number, cn.name, tp.start_date, 
                           tp.end_date, tp.category, tp.archived_date,
                           (SELECT COUNT(DISTINCT ps.teacher_id) 
                            FROM program_schedule ps 
                            WHERE ps.program_id = tp.id AND ps.teacher_id IS NOT NULL) as teacher_count
                    FROM training_programs tp
                    LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                    LEFT JOIN program_schedule ps ON tp.id = ps.program_id
                    LEFT JOIN teachers t ON ps.teacher_id = t.id
                    WHERE tp.is_archived = 1
                    AND (tp.program_number LIKE ? 
                         OR cn.name LIKE ? 
                         OR t.name LIKE ?)
                    ORDER BY tp.archived_date DESC
                """, (f'%{search_text}%', f'%{search_text}%', f'%{search_text}%'))
            else:
                self._load_archived_programs()
                return

            programs = cursor.fetchall()

            for index, program in enumerate(programs):
                display_data = program[1:]
                tag = 'evenrow' if index % 2 == 0 else 'oddrow'
                self.archive_tree.insert("", tk.END, values=display_data,
                                         tags=(tag, f"id_{program[0]}"))

            self.archive_count_label.config(text=f"Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: {len(programs)} Ø¨Ø±Ù†Ø§Ù…Ø¬")

        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: {e}")

    def _search_archive_by_date(self):
        """Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®"""
        from_date = self.archive_from_date.get()
        to_date = self.archive_to_date.get()

        for item in self.archive_tree.get_children():
            self.archive_tree.delete(item)

        try:
            cursor = self.db_conn.cursor()
            cursor.execute("""
                SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                       tp.end_date, tp.category, tp.archived_date,
                       (SELECT COUNT(DISTINCT ps.teacher_id) 
                        FROM program_schedule ps 
                        WHERE ps.program_id = tp.id AND ps.teacher_id IS NOT NULL) as teacher_count
                FROM training_programs tp
                LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                WHERE tp.is_archived = 1
                AND tp.start_date >= ? AND tp.end_date <= ?
                ORDER BY tp.archived_date DESC
            """, (from_date, to_date))

            programs = cursor.fetchall()

            for index, program in enumerate(programs):
                display_data = program[1:]
                tag = 'evenrow' if index % 2 == 0 else 'oddrow'
                self.archive_tree.insert("", tk.END, values=display_data,
                                         tags=(tag, f"id_{program[0]}"))

            self.archive_count_label.config(text=f"Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ù…Ù† {from_date} Ø¥Ù„Ù‰ {to_date}: {len(programs)} Ø¨Ø±Ù†Ø§Ù…Ø¬")

        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ®: {e}")

    def _clear_archive_filters(self):
        """Ù…Ø³Ø­ ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø«"""
        self.archive_search_entry.delete(0, tk.END)
        self._load_archived_programs()

    def _show_archived_program_details(self, event):
        """Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´Ù"""
        selection = self.archive_tree.selection()
        if not selection:
            return

        item = self.archive_tree.item(selection[0])
        tags = item['tags']
        program_id = None
        for tag in tags:
            if tag.startswith('id_'):
                program_id = int(tag.split('_')[1])
                break

        if program_id:
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ø§Ù…Ù„ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
            self._show_program_details_window(program_id, readonly=True)

    def _restore_archived_program(self):
        """Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ"""
        selection = self.archive_tree.selection()
        if not selection:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡")
            return

        item = self.archive_tree.item(selection[0])
        program_number = item['values'][0]

        tags = item['tags']
        program_id = None
        for tag in tags:
            if tag.startswith('id_'):
                program_id = int(tag.split('_')[1])
                break

        if messagebox.askyesno("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©",
                               f"Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: {program_number}ØŸ\n\n"
                               "Ø³ÙŠØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"):
            try:
                cursor = self.db_conn.cursor()
                cursor.execute("""
                    UPDATE training_programs 
                    SET is_archived = 0, archived_date = NULL
                    WHERE id = ?
                """, (program_id,))

                self.db_conn.commit()

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­")
                self._load_archived_programs()

            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

    def _export_all_archive(self):
        """ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©"""
        try:
            cursor = self.db_conn.cursor()
            cursor.execute("""
                SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                       tp.end_date, tp.category, tp.archived_date
                FROM training_programs tp
                LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                WHERE tp.is_archived = 1
                ORDER BY tp.archived_date DESC
            """)

            programs = cursor.fetchall()

            if not programs:
                messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±Ø§Ù…Ø¬ Ù…Ø¤Ø±Ø´ÙØ© Ù„Ù„ØªØµØ¯ÙŠØ±")
                return

            from tkinter import filedialog
            file_path = filedialog.asksaveasfilename(
                title="Ø­ÙØ¸ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬",
                defaultextension=".xlsx",
                initialfile=f"Ø£Ø±Ø´ÙŠÙ_Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬_{datetime.now().strftime('%Y%m%d')}.xlsx",
                filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")]
            )

            if file_path:
                self._create_archive_excel(programs, file_path)

        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

    def _export_selected_archive(self):
        """ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·"""
        selection = self.archive_tree.selection()
        if not selection:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù„Ù„ØªØµØ¯ÙŠØ±")
            return

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
        selected_programs = []

        for item in selection:
            tags = self.archive_tree.item(item)['tags']
            program_id = None
            for tag in tags:
                if tag.startswith('id_'):
                    program_id = int(tag.split('_')[1])
                    break
            if program_id:
                selected_programs.append(program_id)

        if not selected_programs:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ù…Ø®ØªØ§Ø±")
            return

        try:
            cursor = self.db_conn.cursor()
            placeholders = ','.join(['?' for _ in selected_programs])
            cursor.execute(f"""
                SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                       tp.end_date, tp.category, tp.archived_date
                FROM training_programs tp
                LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                WHERE tp.id IN ({placeholders})
                ORDER BY tp.archived_date DESC
            """, selected_programs)

            programs_data = cursor.fetchall()

            from tkinter import filedialog

            # Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙŠØ¹ÙƒØ³ Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            if len(programs_data) == 1:
                filename = f"Ø¨Ø±Ù†Ø§Ù…Ø¬_{programs_data[0][1]}_{datetime.now().strftime('%Y%m%d')}.xlsx"
            else:
                filename = f"Ø¨Ø±Ø§Ù…Ø¬_Ù…Ø¤Ø±Ø´ÙØ©_{len(programs_data)}_{datetime.now().strftime('%Y%m%d')}.xlsx"

            file_path = filedialog.asksaveasfilename(
                title="Ø­ÙØ¸ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©",
                defaultextension=".xlsx",
                initialfile=filename,
                filetypes=[("Excel files", "*.xlsx"), ("All files", "*.*")]
            )

            if file_path:
                self._create_archive_excel(programs_data, file_path)

        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

    def _create_archive_excel(self, programs_list, file_path):
        """Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel Ù„Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ© Ø¨ØªØµÙ…ÙŠÙ… Ù…Ø­Ø³Ù† ÙˆØ¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©"""
        if not EXCEL_AVAILABLE:
            messagebox.showerror("Ø®Ø·Ø£", "ÙŠØ¬Ø¨ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\npip install pandas openpyxl")
            return

        try:
            import pandas as pd
            from openpyxl import Workbook
            from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
            from openpyxl.utils import get_column_letter

            wb = Workbook()

            # Ø­Ø°Ù Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            if 'Sheet' in wb.sheetnames:
                wb.remove(wb['Sheet'])

            # 1. ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ø§Ù…
            summary_ws = wb.create_sheet('Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©')
            summary_ws.sheet_view.rightToLeft = True

            # ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù…
            header_font = Font(name='Arial', size=14, bold=True, color='000000')
            header_fill = PatternFill(start_color='D3D3D3', end_color='D3D3D3', fill_type='solid')
            cell_font = Font(name='Arial', size=12)
            center_alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
            right_alignment = Alignment(horizontal='right', vertical='center', wrap_text=True)
            thin_border = Border(
                left=Side(style='thin'),
                right=Side(style='thin'),
                top=Side(style='thin'),
                bottom=Side(style='thin')
            )

            # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
            summary_ws.merge_cells('A1:J1')
            title_cell = summary_ws['A1']
            title_cell.value = 'Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©'
            title_cell.font = Font(name='Arial', size=18, bold=True)
            title_cell.alignment = center_alignment
            title_cell.fill = PatternFill(start_color='1E3A5F', end_color='1E3A5F', fill_type='solid')
            title_cell.font = Font(name='Arial', size=18, bold=True, color='FFFFFF')

            # Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            headers = [
                'Ù…',
                'Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬',
                'Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©',
                'Ø§Ù„ÙØ¦Ø©',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©',
                'Ø§Ù„Ù…Ø¯Ø© (Ø£ÙŠØ§Ù…)',
                'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯',
                'Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…Ù†Ø³ÙˆØ¨ÙŠÙ†',
                'Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…ØªØ¹Ø§ÙˆÙ†ÙŠÙ†',
                'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†',
                'Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©'
            ]

            # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø¤ÙˆØ³
            for col, header in enumerate(headers, 1):
                cell = summary_ws.cell(row=3, column=col)
                cell.value = header
                cell.font = header_font
                cell.fill = header_fill
                cell.alignment = center_alignment
                cell.border = thin_border

            # Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
            row_num = 4
            cursor = self.db_conn.cursor()

            for idx, program in enumerate(programs_list, 1):
                program_id = program[0]

                # Ø­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                from datetime import datetime
                start_date = datetime.strptime(program[3], "%Y-%m-%d")
                end_date = datetime.strptime(program[4], "%Y-%m-%d")
                duration = (end_date - start_date).days + 1

                # Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯
                cursor.execute("""
                    SELECT COUNT(*) FROM program_subjects 
                    WHERE program_id = ? AND subject_order != 999
                """, (program_id,))
                subject_count = cursor.fetchone()[0]

                # Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…Ù†Ø³ÙˆØ¨ÙŠÙ†
                cursor.execute("""
                    SELECT COUNT(DISTINCT ps.teacher_id)
                    FROM program_schedule ps
                    JOIN teachers t ON ps.teacher_id = t.id
                    WHERE ps.program_id = ? AND t.category = 'Ù…Ù†Ø³ÙˆØ¨ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'
                """, (program_id,))
                city_teachers = cursor.fetchone()[0]

                # Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…ØªØ¹Ø§ÙˆÙ†ÙŠÙ†
                cursor.execute("""
                    SELECT COUNT(DISTINCT ps.teacher_id)
                    FROM program_schedule ps
                    JOIN teachers t ON ps.teacher_id = t.id
                    WHERE ps.program_id = ? AND t.category != 'Ù…Ù†Ø³ÙˆØ¨ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'
                """, (program_id,))
                collaborator_teachers = cursor.fetchone()[0]

                # Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                cursor.execute("""
                    SELECT COUNT(*) FROM program_schedule
                    WHERE program_id = ? AND is_break = 0
                """, (program_id,))
                total_sessions = cursor.fetchone()[0]

                # ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                data = [
                    idx,  # Ù…
                    program[1],  # Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                    program[2],  # Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©
                    program[5],  # Ø§Ù„ÙØ¦Ø©
                    program[3],  # ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                    program[4],  # ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                    duration,  # Ø§Ù„Ù…Ø¯Ø©
                    subject_count,  # Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯
                    city_teachers,  # Ø§Ù„Ù…Ù†Ø³ÙˆØ¨ÙŠÙ†
                    collaborator_teachers,  # Ø§Ù„Ù…ØªØ¹Ø§ÙˆÙ†ÙŠÙ†
                    city_teachers + collaborator_teachers,  # Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                    total_sessions,  # Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ
                    program[6] if len(program) > 6 else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'  # ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©
                ]

                for col, value in enumerate(data, 1):
                    cell = summary_ws.cell(row=row_num, column=col)
                    cell.value = value
                    cell.font = cell_font
                    cell.alignment = center_alignment if col <= 2 else right_alignment
                    cell.border = thin_border

                    # ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙÙˆÙ
                    if row_num % 2 == 0:
                        cell.fill = PatternFill(start_color='F5F5F5', end_color='F5F5F5', fill_type='solid')

                row_num += 1

            # Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            column_widths = {
                'A': 5,  # Ù…
                'B': 15,  # Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                'C': 35,  # Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©
                'D': 12,  # Ø§Ù„ÙØ¦Ø©
                'E': 15,  # ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                'F': 15,  # ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
                'G': 12,  # Ø§Ù„Ù…Ø¯Ø©
                'H': 12,  # Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯
                'I': 18,  # Ø§Ù„Ù…Ù†Ø³ÙˆØ¨ÙŠÙ†
                'J': 18,  # Ø§Ù„Ù…ØªØ¹Ø§ÙˆÙ†ÙŠÙ†
                'K': 15,  # Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
                'L': 12,  # Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ
                'M': 18  # ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©
            }

            for col, width in column_widths.items():
                summary_ws.column_dimensions[col].width = width

            # Ø¥Ø¶Ø§ÙØ© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­Ø³Ù†
            stats_row = row_num + 2

            # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            summary_ws.merge_cells(f'A{stats_row}:M{stats_row}')
            stats_title = summary_ws[f'A{stats_row}']
            stats_title.value = 'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©'
            stats_title.font = Font(name='Arial', size=16, bold=True, color='FFFFFF')
            stats_title.fill = PatternFill(start_color='1E3A5F', end_color='1E3A5F', fill_type='solid')
            stats_title.alignment = center_alignment
            stats_title.border = thin_border

            # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            total_programs = len(programs_list)
            total_duration = sum([
                (datetime.strptime(p[4], "%Y-%m-%d") - datetime.strptime(p[3], "%Y-%m-%d")).days + 1
                for p in programs_list
            ])

            # Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† ÙˆØ§Ù„Ø­ØµØµ
            total_city_teachers = 0
            total_collab_teachers = 0
            total_all_sessions = 0

            for program in programs_list:
                cursor.execute("""
                    SELECT COUNT(DISTINCT ps.teacher_id)
                    FROM program_schedule ps
                    JOIN teachers t ON ps.teacher_id = t.id
                    WHERE ps.program_id = ? AND t.category = 'Ù…Ù†Ø³ÙˆØ¨ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'
                """, (program[0],))
                total_city_teachers += cursor.fetchone()[0]

                cursor.execute("""
                    SELECT COUNT(DISTINCT ps.teacher_id)
                    FROM program_schedule ps
                    JOIN teachers t ON ps.teacher_id = t.id
                    WHERE ps.program_id = ? AND t.category != 'Ù…Ù†Ø³ÙˆØ¨ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©'
                """, (program[0],))
                total_collab_teachers += cursor.fetchone()[0]

                cursor.execute("""
                    SELECT COUNT(*) FROM program_schedule
                    WHERE program_id = ? AND is_break = 0
                """, (program[0],))
                total_all_sessions += cursor.fetchone()[0]

            # ØµÙ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            stats_row += 2

            # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ Ù…Ø¹ ØªÙ†Ø³ÙŠÙ‚ Ø¬Ù…ÙŠÙ„
            stats_items = [
                ('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬:', total_programs, 'A', 'B'),
                ('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨:', total_duration, 'C', 'D'),
                ('Ù…ØªÙˆØ³Ø· Ù…Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:', f'{total_duration // total_programs if total_programs > 0 else 0} ÙŠÙˆÙ…', 'E',
                 'F'),
                ('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…Ù†Ø³ÙˆØ¨ÙŠÙ†:', total_city_teachers, 'G', 'H'),
                ('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…ØªØ¹Ø§ÙˆÙ†ÙŠÙ†:', total_collab_teachers, 'I', 'J'),
                ('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ØµØµ:', total_all_sessions, 'K', 'L')
            ]

            for label, value, label_col, value_col in stats_items:
                # Ø®Ù„ÙŠØ© Ø§Ù„ØªØ³Ù…ÙŠØ©
                label_cell = summary_ws[f'{label_col}{stats_row}']
                label_cell.value = label
                label_cell.font = Font(name='Arial', size=12, bold=True)
                label_cell.fill = PatternFill(start_color='E8E8E8', end_color='E8E8E8', fill_type='solid')
                label_cell.alignment = right_alignment
                label_cell.border = thin_border

                # Ø®Ù„ÙŠØ© Ø§Ù„Ù‚ÙŠÙ…Ø©
                value_cell = summary_ws[f'{value_col}{stats_row}']
                value_cell.value = value
                value_cell.font = Font(name='Arial', size=12, bold=True, color='000080')
                value_cell.fill = PatternFill(start_color='F0F8FF', end_color='F0F8FF', fill_type='solid')
                value_cell.alignment = center_alignment
                value_cell.border = thin_border

            # 2. Ø£ÙˆØ±Ø§Ù‚ ØªÙØµÙŠÙ„ÙŠØ© Ù„ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ (Ø£ÙˆÙ„ 10 Ø¨Ø±Ø§Ù…Ø¬)
            for idx, program in enumerate(programs_list[:10]):
                program_id = program[0]
                program_number = program[1]

                # ÙˆØ±Ù‚Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                sheet_name = f'Ø¨Ø±Ù†Ø§Ù…Ø¬_{program_number}'[:31]
                detail_ws = wb.create_sheet(sheet_name)
                detail_ws.sheet_view.rightToLeft = True

                # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
                detail_ws.merge_cells('A1:G1')
                main_title = detail_ws['A1']
                main_title.value = 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ'
                main_title.font = Font(name='Arial', size=20, bold=True, color='FFFFFF')
                main_title.fill = PatternFill(start_color='1E3A5F', end_color='1E3A5F', fill_type='solid')
                main_title.alignment = center_alignment
                for col in range(1, 8):
                    detail_ws.cell(row=1, column=col).border = thin_border

                # Ø¹Ù†ÙˆØ§Ù† ÙØ±Ø¹ÙŠ Ù…Ø¹ Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                detail_ws.merge_cells('A2:G2')
                sub_title = detail_ws['A2']
                sub_title.value = f'{program[2]} - Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: {program_number}'
                sub_title.font = Font(name='Arial', size=16, bold=True, color='000080')
                sub_title.fill = PatternFill(start_color='E6F3FF', end_color='E6F3FF', fill_type='solid')
                sub_title.alignment = center_alignment
                for col in range(1, 8):
                    detail_ws.cell(row=2, column=col).border = thin_border

                # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ù†Ø³Ù‚
                current_row = 4

                # Ø¹Ù†ÙˆØ§Ù† Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                detail_ws.merge_cells(f'A{current_row}:G{current_row}')
                info_section = detail_ws[f'A{current_row}']
                info_section.value = 'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬'
                info_section.font = Font(name='Arial', size=14, bold=True, color='FFFFFF')
                info_section.fill = PatternFill(start_color='17a2b8', end_color='17a2b8', fill_type='solid')
                info_section.alignment = center_alignment
                for col in range(1, 8):
                    detail_ws.cell(row=current_row, column=col).border = thin_border

                current_row += 1

                # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ ØµÙÙŠÙ†
                program_info_row1 = [
                    ('Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:', program[1]),
                    ('Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:', program[2]),
                    ('Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©:', program[5])
                ]

                program_info_row2 = [
                    ('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:', program[3]),
                    ('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:', program[4]),
                    ('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø£Ø±Ø´ÙØ©:', program[6] if len(program) > 6 else 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')
                ]

                # Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                col_idx = 1
                for label, value in program_info_row1:
                    label_cell = detail_ws.cell(row=current_row, column=col_idx)
                    label_cell.value = label
                    label_cell.font = Font(name='Arial', size=12, bold=True)
                    label_cell.fill = PatternFill(start_color='E8E8E8', end_color='E8E8E8', fill_type='solid')
                    label_cell.alignment = right_alignment
                    label_cell.border = thin_border

                    value_cell = detail_ws.cell(row=current_row, column=col_idx + 1)
                    value_cell.value = value
                    value_cell.font = Font(name='Arial', size=12)
                    value_cell.alignment = center_alignment
                    value_cell.border = thin_border

                    col_idx += 2

                current_row += 1

                # Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                col_idx = 1
                for label, value in program_info_row2:
                    label_cell = detail_ws.cell(row=current_row, column=col_idx)
                    label_cell.value = label
                    label_cell.font = Font(name='Arial', size=12, bold=True)
                    label_cell.fill = PatternFill(start_color='E8E8E8', end_color='E8E8E8', fill_type='solid')
                    label_cell.alignment = right_alignment
                    label_cell.border = thin_border

                    value_cell = detail_ws.cell(row=current_row, column=col_idx + 1)
                    value_cell.value = value
                    value_cell.font = Font(name='Arial', size=12)
                    value_cell.alignment = center_alignment
                    value_cell.border = thin_border

                    col_idx += 2

                current_row += 1

                # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
                current_row += 2
                detail_ws.merge_cells(f'A{current_row}:G{current_row}')
                teachers_title = detail_ws[f'A{current_row}']
                teachers_title.value = 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬'
                teachers_title.font = Font(name='Arial', size=14, bold=True, color='FFFFFF')
                teachers_title.fill = PatternFill(start_color='28a745', end_color='28a745', fill_type='solid')
                teachers_title.alignment = center_alignment
                for col in range(1, 8):
                    detail_ws.cell(row=current_row, column=col).border = thin_border

                current_row += 1

                # Ø±Ø¤ÙˆØ³ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
                teacher_headers = ['Ù…', 'Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³', 'Ø§Ù„Ø±ØªØ¨Ø©', 'Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©', 'Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„', 'Ø§Ù„ÙØ¦Ø©', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­ØµØµ']
                for col, header in enumerate(teacher_headers, 1):
                    cell = detail_ws.cell(row=current_row, column=col)
                    cell.value = header
                    cell.font = header_font
                    cell.fill = header_fill
                    cell.alignment = center_alignment
                    cell.border = thin_border

                current_row += 1

                # Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
                cursor.execute("""
                    SELECT DISTINCT t.name, t.rank, t.id_number, t.workplace, t.category,
                           COUNT(ps.id) as session_count
                    FROM teachers t
                    JOIN program_schedule ps ON t.id = ps.teacher_id
                    WHERE ps.program_id = ?
                    GROUP BY t.id
                    ORDER BY t.category, t.name
                """, (program_id,))

                teachers = cursor.fetchall()

                for idx, teacher in enumerate(teachers, 1):
                    teacher_data = [idx] + list(teacher)
                    for col, value in enumerate(teacher_data, 1):
                        cell = detail_ws.cell(row=current_row, column=col)
                        cell.value = value
                        cell.font = cell_font
                        cell.alignment = center_alignment if col == 1 else right_alignment
                        cell.border = thin_border
                        if current_row % 2 == 0:
                            cell.fill = PatternFill(start_color='F5F5F5', end_color='F5F5F5', fill_type='solid')
                    current_row += 1

                # Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
                detail_widths = {
                    'A': 5,
                    'B': 25,
                    'C': 15,
                    'D': 15,
                    'E': 30,
                    'F': 15,
                    'G': 12
                }

                for col, width in detail_widths.items():
                    detail_ws.column_dimensions[col].width = width

            # Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
            wb.save(file_path)
            messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­\n{file_path}")

        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ±: {str(e)}")

    def _show_program_details_window(self, program_id, readonly=False):
        """Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ Ù†Ø§ÙØ°Ø© (Ù„Ù„Ø£Ø±Ø´ÙŠÙ ÙˆØ§Ù„Ø¹Ø§Ø¯ÙŠ)"""
        detail_window = tk.Toplevel(self)
        detail_window.title("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ")
        detail_window.state('zoomed')
        detail_window.configure(bg=self.COLORS["background"])
        detail_window.transient(self)
        detail_window.grab_set()

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        cursor = self.db_conn.cursor()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        cursor.execute("PRAGMA table_info(training_programs)")
        columns = [column[1] for column in cursor.fetchall()]

        # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©
        base_query = """
            SELECT tp.program_number, cn.name, tp.start_date, tp.end_date, tp.category
        """

        extra_fields = []
        if 'has_classes' in columns:
            extra_fields.append("tp.has_classes")
        else:
            extra_fields.append("0 as has_classes")

        if 'classes_count' in columns:
            extra_fields.append("tp.classes_count")
        else:
            extra_fields.append("1 as classes_count")

        if 'is_archived' in columns:
            extra_fields.append("tp.is_archived")
        else:
            extra_fields.append("0 as is_archived")

        query = base_query + ", " + ", ".join(extra_fields) + """
            FROM training_programs tp
            LEFT JOIN course_names cn ON tp.course_name_id = cn.id
            WHERE tp.id = ?
        """

        cursor.execute(query, (program_id,))
        program = cursor.fetchone()

        if not program:
            messagebox.showerror("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬")
            detail_window.destroy()
            return

        has_classes = program[5] if len(program) > 5 else 0
        classes_count = program[6] if len(program) > 6 else 1
        is_archived = program[7] if len(program) > 7 else 0

        # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
        from datetime import datetime
        start_date = datetime.strptime(program[2], "%Y-%m-%d")
        end_date = datetime.strptime(program[3], "%Y-%m-%d")
        weeks = ((end_date - start_date).days // 7) + 1

        # Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ­ÙƒÙ…
        selected_week = tk.IntVar(value=1)
        selected_class = tk.IntVar(value=1)

        # Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† - Ù†ÙØ³ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø±Ø³Ù…ÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹
        header_frame = tk.Frame(detail_window, bg="#1E3A5F", height=80)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)

        header_content = tk.Frame(header_frame, bg="#1E3A5F")
        header_content.pack(expand=True, fill=tk.BOTH, padx=30)

        title_text = f"Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ: {program[0]} - {program[1]}"
        if is_archived == 1:
            title_text += " (Ù…Ø¤Ø±Ø´Ù)"

        title_label = tk.Label(
            header_content,
            text=title_text,
            font=("Tajawal", 24, "bold"),
            bg="#1E3A5F",
            fg="white"
        )
        title_label.pack(side=tk.LEFT, pady=20)

        # Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        buttons_container = tk.Frame(header_content, bg="#1E3A5F")
        buttons_container.pack(side=tk.LEFT, pady=20)

        # Ø²Ø± ØªØµØ¯ÙŠØ± Ù„Ù„Ù…Ø¯Ø±Ø³
        export_teacher_btn = tk.Button(
            buttons_container,
            text="ØªØµØ¯ÙŠØ± Ù„Ù„Ù…Ø¯Ø±Ø³",
            font=("Tajawal", 14, "bold"),
            bg="#17a2b8",
            fg="white",
            padx=20,
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._export_schedule_for_teacher(
                program_id,
                selected_week.get(),
                selected_class.get() if has_classes else 1
            )
        )
        export_teacher_btn.pack(side=tk.LEFT, padx=(0, 5))

        # Ø²Ø± ØªØµØ¯ÙŠØ± Ø¹Ø§Ù…
        export_general_btn = tk.Button(
            buttons_container,
            text="ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„",
            font=("Tajawal", 14, "bold"),
            bg="#6c757d",
            fg="white",
            padx=20,
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._export_general_schedule(
                program_id,
                selected_week.get(),
                selected_class.get() if has_classes else 1
            )
        )
        export_general_btn.pack(side=tk.LEFT, padx=(0, 5))

        # Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø©
        buttons_container2 = tk.Frame(header_content, bg="#1E3A5F")
        buttons_container2.pack(side=tk.RIGHT, pady=20)

        # Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ÙÙ‚Ø· Ù„Ù„Ø¨Ø±Ø§Ù…Ø¬ ØºÙŠØ± Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ©)
        if not readonly and is_archived != 1:
            manage_schedule_btn = tk.Button(
                buttons_container2,
                text="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„",
                font=("Tajawal", 14, "bold"),
                bg="#28a745",
                fg="white",
                padx=25,
                pady=8,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=lambda: [detail_window.destroy(),
                                 self._manage_program_schedule(program_id, program[0], self)]
            )
            manage_schedule_btn.pack(side=tk.LEFT, padx=(0, 10))

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        close_btn = tk.Button(
            buttons_container2,
            text="Ø¥ØºÙ„Ø§Ù‚",
            font=("Tajawal", 14, "bold"),
            bg="#dc3545",
            fg="white",
            padx=25,
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=detail_window.destroy
        )
        close_btn.pack(side=tk.LEFT)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        main_frame = tk.Frame(detail_window, bg=self.COLORS["background"])
        main_frame.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        info_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], relief=tk.RIDGE, bd=1)
        info_frame.pack(fill=tk.X, pady=(0, 10))

        inner_info = tk.Frame(info_frame, bg=self.COLORS["surface"], padx=20, pady=15)
        inner_info.pack(fill=tk.X)

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯
        info_items = [
            ("Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:", program[0]),
            ("Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:", program[1]),
            ("Ø§Ù„ÙØ¦Ø©:", program[4]),
            ("Ù…Ù†:", program[2]),
            ("Ø¥Ù„Ù‰:", program[3]),
            ("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹:", f"{weeks} Ø£Ø³Ø§Ø¨ÙŠØ¹")
        ]

        if has_classes:
            info_items.append(("Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„:", f"{classes_count} ÙØµÙˆÙ„"))

        if is_archived == 1:
            info_items.append(("Ø§Ù„Ø­Ø§Ù„Ø©:", "Ù…Ø¤Ø±Ø´Ù"))

        for i, (label, value) in enumerate(info_items):
            item_frame = tk.Frame(inner_info, bg=self.COLORS["surface"])
            item_frame.pack(side=tk.LEFT, expand=True, padx=5)

            tk.Label(
                item_frame,
                text=label,
                font=("Tajawal", 12, "bold"),
                bg=self.COLORS["surface"],
                fg="#1E3A5F"
            ).pack(side=tk.LEFT)

            tk.Label(
                item_frame,
                text=value,
                font=("Tajawal", 12),
                bg=self.COLORS["surface"],
                fg="#333"
            ).pack(side=tk.LEFT, padx=(5, 0))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯
        subjects_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], relief=tk.RIDGE, bd=1)
        subjects_frame.pack(fill=tk.X, pady=(0, 10))

        subjects_container = tk.Frame(subjects_frame, bg=self.COLORS["surface"], padx=15, pady=10)
        subjects_container.pack(fill=tk.X)

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯
        tk.Label(
            subjects_container,
            text="Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:",
            font=("Tajawal", 13, "bold"),
            bg=self.COLORS["surface"],
            fg="#1E3A5F"
        ).pack(side=tk.LEFT, padx=(0, 15))

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯
        cursor.execute("""
            SELECT id, subject_name, subject_order 
            FROM program_subjects 
            WHERE program_id = ? AND subject_order != 999
            ORDER BY subject_order
        """, (program_id,))

        subjects = cursor.fetchall()

        # Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø£ÙÙ‚ÙŠØ§Ù‹
        for idx, subject in enumerate(subjects):
            if idx > 0:
                tk.Label(
                    subjects_container,
                    text=" | ",
                    font=("Tajawal", 13),
                    bg=self.COLORS["surface"],
                    fg="#999"
                ).pack(side=tk.LEFT)

            tk.Label(
                subjects_container,
                text=f"{subject[2]}. {subject[1]}",
                font=("Tajawal", 13),
                bg=self.COLORS["surface"],
                fg="#333"
            ).pack(side=tk.LEFT, padx=5)

        # Ø¥Ø·Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„ÙØµÙ„
        week_selector_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], height=50)
        week_selector_frame.pack(fill=tk.X, pady=(0, 10))
        week_selector_frame.pack_propagate(False)

        week_container = tk.Frame(week_selector_frame, bg=self.COLORS["surface"])
        week_container.pack(expand=True, fill=tk.BOTH, padx=20, pady=5)

        # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        tk.Label(
            week_container,
            text="Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:",
            font=("Tajawal", 14, "bold"),
            bg=self.COLORS["surface"],
            fg="#1E3A5F"
        ).pack(side=tk.LEFT, padx=(0, 15))

        # Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
        weeks_buttons_frame = tk.Frame(week_container, bg=self.COLORS["surface"])
        weeks_buttons_frame.pack(side=tk.LEFT)

        week_buttons = []

        def show_week_schedule(week_num):
            """Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø£Ø³Ø¨ÙˆØ¹ Ù…Ø­Ø¯Ø¯"""
            selected_week.set(week_num)

            # ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            for i, btn in enumerate(week_buttons):
                if i + 1 == week_num:
                    btn.config(bg="#1E3A5F", fg="white")
                else:
                    btn.config(bg="#E0E0E0", fg="black")

            # ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            for widget in schedule_container.winfo_children():
                widget.destroy()
            self._create_schedule_view(
                schedule_container, program_id,
                week_number=week_num,
                class_number=selected_class.get() if has_classes else 1,
                readonly=True
            )

        # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
        for week in range(1, weeks + 1):
            week_btn = tk.Button(
                weeks_buttons_frame,
                text=f"Ø£Ø³Ø¨ÙˆØ¹ {week}",
                font=("Tajawal", 11, "bold"),
                bg="#E0E0E0" if week != 1 else "#1E3A5F",
                fg="black" if week != 1 else "white",
                width=9,
                height=1,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=lambda w=week: show_week_schedule(w)
            )
            week_btn.pack(side=tk.LEFT, padx=3)
            week_buttons.append(week_btn)

            # ØªØ£Ø«ÙŠØ±Ø§Øª hover
            def on_enter(e, btn=week_btn, week_num=week):
                if selected_week.get() != week_num:
                    btn.config(bg="#BDBDBD")

            def on_leave(e, btn=week_btn, week_num=week):
                if selected_week.get() == week_num:
                    btn.config(bg="#1E3A5F", fg="white")
                else:
                    btn.config(bg="#E0E0E0", fg="black")

            week_btn.bind("<Enter>", on_enter)
            week_btn.bind("<Leave>", on_leave)

        # Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„ÙØµÙˆÙ„ Ø¥Ù† ÙˆØ¬Ø¯Øª
        if has_classes:
            tk.Label(
                week_container,
                text=" | ",
                font=("Tajawal", 14),
                bg=self.COLORS["surface"],
                fg="#999"
            ).pack(side=tk.LEFT, padx=20)

            tk.Label(
                week_container,
                text="Ø§Ù„ÙØµÙ„:",
                font=("Tajawal", 14, "bold"),
                bg=self.COLORS["surface"],
                fg="#FF6B35"
            ).pack(side=tk.LEFT, padx=(0, 10))

            class_names = [f"ÙØµÙ„ {i}" for i in range(1, classes_count + 1)]

            class_combo = ttk.Combobox(
                week_container,
                values=class_names,
                font=("Tajawal", 12, "bold"),
                state="readonly",
                width=12
            )
            class_combo.current(0)
            class_combo.pack(side=tk.LEFT)

            def on_class_change(event):
                selected_text = class_combo.get()
                class_num = int(selected_text.split()[1])
                selected_class.set(class_num)

                for widget in schedule_container.winfo_children():
                    widget.destroy()
                self._create_schedule_view(
                    schedule_container, program_id,
                    week_number=selected_week.get(),
                    class_number=class_num,
                    readonly=True
                )

            class_combo.bind('<<ComboboxSelected>>', on_class_change)

        # Ø®Ø· ÙØ§ØµÙ„
        separator = tk.Frame(main_frame, bg=self.COLORS["border"], height=2)
        separator.pack(fill=tk.X, padx=15, pady=(0, 10))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
        schedule_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], relief=tk.RIDGE, bd=1)
        schedule_frame.pack(fill=tk.BOTH, expand=True)

        schedule_header = tk.Frame(schedule_frame, bg="#1E3A5F", height=35)
        schedule_header.pack(fill=tk.X)
        schedule_header.pack_propagate(False)

        tk.Label(
            schedule_header,
            text="Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ",
            font=("Tajawal", 14, "bold"),
            bg="#1E3A5F",
            fg="white"
        ).pack(expand=True)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
        schedule_container = tk.Frame(schedule_frame, bg="white", padx=10, pady=10)
        schedule_container.pack(fill=tk.BOTH, expand=True)

        # Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
        show_week_schedule(1)

    # 2. Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙØµÙˆÙ„
    def _add_training_program(self):
        """Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªØ®ØµØµÙŠØ© ÙˆØ§Ù„ÙØµÙˆÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©"""
        add_window = tk.Toplevel(self)
        add_window.title("ØªÙ†ÙÙŠØ° Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ")
        add_window.state('zoomed')
        add_window.configure(bg=self.COLORS["background"])
        add_window.transient(self)
        add_window.grab_set()

        # Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        header_frame = tk.Frame(add_window, bg="#1E3A5F", height=100)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)

        header_content = tk.Frame(header_frame, bg="#1E3A5F")
        header_content.pack(expand=True, fill=tk.BOTH, padx=30)

        title_label = tk.Label(
            header_content,
            text="ØªÙ†ÙÙŠØ° Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¬Ø¯ÙŠØ¯",
            font=("Tajawal", 28, "bold"),
            bg="#1E3A5F",
            fg="white"
        )
        title_label.pack(side=tk.LEFT, pady=25)

        buttons_container = tk.Frame(header_content, bg="#1E3A5F")
        buttons_container.pack(side=tk.RIGHT, pady=25)

        # Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸
        def save_program():
            program_number = program_number_entry.get().strip()
            course_name = course_entry.get().strip()
            start_date = start_date_entry.get()
            end_date = end_date_entry.get()
            category = category_var.get()

            if not all([program_number, course_name, start_date, end_date]):
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©")
                return

            if course_name not in course_names:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©")
                return

            # Ø¬Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø© ÙˆØ§Ù„ØªØ®ØµØµÙŠØ©
            general_subjects = []
            specialized_subjects = []

            for i, (entry, category_type) in enumerate(subjects_entries):
                subject_name = entry.get().strip()
                if subject_name:
                    if category_type == "general":
                        general_subjects.append((subject_name, i + 1, "general"))
                    else:
                        specialized_subjects.append((subject_name, i + 1, "specialized"))

            all_subjects = general_subjects + specialized_subjects

            if not all_subjects:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„")
                return

            # Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            schedule_type_response = messagebox.askyesno(
                "Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„",
                "Ù‡Ù„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ØŸ\n\n"
                "Ù†Ø¹Ù… = Ø¬Ø¯ÙˆÙ„ Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹\n"
                "Ù„Ø§ = Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ø­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬"
            )

            schedule_type = "multiple" if schedule_type_response else "single"

            # Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„ÙØµÙˆÙ„
            has_classes = False
            classes_count = 1

            classes_response = messagebox.askyesno(
                "Ø§Ù„ÙØµÙˆÙ„",
                "Ù‡Ù„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ØŸ\n\n"
                "Ù†Ø¹Ù… = Ø¹Ø¯Ø© ÙØµÙˆÙ„ (Ù…Ø¬Ù…ÙˆØ¹Ø§Øª) ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬\n"
                "Ù„Ø§ = ÙØµÙ„ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·"
            )

            if classes_response:
                # Ù†Ø§ÙØ°Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„
                classes_dialog = tk.Toplevel(add_window)
                classes_dialog.title("Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„")
                classes_dialog.geometry("400x200")
                classes_dialog.configure(bg=self.COLORS["surface"])
                classes_dialog.transient(add_window)
                classes_dialog.grab_set()

                # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
                classes_dialog.update_idletasks()
                x = (classes_dialog.winfo_screenwidth() - 400) // 2
                y = (classes_dialog.winfo_screenheight() - 200) // 2
                classes_dialog.geometry(f"400x200+{x}+{y}")

                content = tk.Frame(classes_dialog, bg=self.COLORS["surface"], padx=30, pady=30)
                content.pack(fill=tk.BOTH, expand=True)

                tk.Label(
                    content,
                    text="ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„ØŸ",
                    font=("Tajawal", 16, "bold"),
                    bg=self.COLORS["surface"]
                ).pack(pady=10)

                classes_var = tk.IntVar(value=2)
                classes_spinbox = tk.Spinbox(
                    content,
                    from_=2,
                    to=10,
                    textvariable=classes_var,
                    font=("Tajawal", 14),
                    width=10
                )
                classes_spinbox.pack(pady=10)

                result = {"confirmed": False, "count": 1}

                def confirm_classes():
                    result["confirmed"] = True
                    result["count"] = classes_var.get()
                    classes_dialog.destroy()

                tk.Button(
                    content,
                    text="ØªØ£ÙƒÙŠØ¯",
                    font=("Tajawal", 14, "bold"),
                    bg=self.COLORS["success"],
                    fg="white",
                    padx=30,
                    pady=8,
                    bd=0,
                    command=confirm_classes
                ).pack(pady=10)

                classes_dialog.wait_window()

                if result["confirmed"]:
                    has_classes = True
                    classes_count = result["count"]

            try:
                cursor = self.db_conn.cursor()

                cursor.execute("SELECT COUNT(*) FROM training_programs WHERE program_number = ?",
                               (program_number,))
                if cursor.fetchone()[0] > 0:
                    messagebox.showerror("Ø®Ø·Ø£", "Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹")
                    return

                course_id = course_ids.get(course_name)

                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                cursor.execute("PRAGMA table_info(training_programs)")
                columns = [column[1] for column in cursor.fetchall()]

                if 'has_classes' not in columns:
                    cursor.execute("ALTER TABLE training_programs ADD COLUMN has_classes INTEGER DEFAULT 0")
                if 'classes_count' not in columns:
                    cursor.execute("ALTER TABLE training_programs ADD COLUMN classes_count INTEGER DEFAULT 1")

                cursor.execute("""
                    INSERT INTO training_programs 
                    (program_number, course_name_id, start_date, end_date, category, 
                     created_date, schedule_type, has_classes, classes_count)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
                """, (program_number, course_id, start_date, end_date, category,
                      datetime.now().strftime("%Y-%m-%d %H:%M:%S"), schedule_type,
                      1 if has_classes else 0, classes_count))

                program_id = cursor.lastrowid

                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹
                for subject_name, order, subject_category in all_subjects:
                    cursor.execute("""
                        INSERT INTO program_subjects (program_id, subject_name, subject_order, subject_category)
                        VALUES (?, ?, ?, ?)
                    """, (program_id, subject_name, order, subject_category))

                self.db_conn.commit()

                if schedule_type == "single":
                    if messagebox.askyesno("Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„", "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ø§Ù„Ø¢Ù†ØŸ"):
                        add_window.destroy()
                        self._manage_program_schedule(program_id, program_number, self)
                    else:
                        messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­")
                        add_window.destroy()
                        self._load_training_programs()
                else:
                    messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­")
                    add_window.destroy()
                    self._load_training_programs()

            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

        # Ø²Ø± Ø§Ù„Ø­ÙØ¸
        save_btn = tk.Button(
            buttons_container,
            text="âœ“ Ø­ÙØ¸",
            font=("Tajawal", 16, "bold"),
            bg="#28a745",
            fg="white",
            padx=30,
            pady=10,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=save_program
        )
        save_btn.pack(side=tk.LEFT, padx=(0, 10))

        save_btn.bind("<Enter>", lambda e: save_btn.config(bg="#218838"))
        save_btn.bind("<Leave>", lambda e: save_btn.config(bg="#28a745"))

        # Ø²Ø± Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        cancel_btn = tk.Button(
            buttons_container,
            text="âœ• Ø¥Ù„ØºØ§Ø¡",
            font=("Tajawal", 16, "bold"),
            bg="#dc3545",
            fg="white",
            padx=30,
            pady=10,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=add_window.destroy
        )
        cancel_btn.pack(side=tk.LEFT)

        cancel_btn.bind("<Enter>", lambda e: cancel_btn.config(bg="#c82333"))
        cancel_btn.bind("<Leave>", lambda e: cancel_btn.config(bg="#dc3545"))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        main_frame = tk.Frame(add_window, bg=self.COLORS["background"])
        main_frame.pack(fill=tk.BOTH, expand=True, padx=50, pady=30)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        info_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], relief=tk.RIDGE, bd=2)
        info_frame.pack(fill=tk.X, pady=(0, 30))

        inner_info = tk.Frame(info_frame, bg=self.COLORS["surface"], padx=50, pady=30)
        inner_info.pack(fill=tk.BOTH)

        inner_info.grid_columnconfigure(1, weight=1)
        inner_info.grid_columnconfigure(3, weight=1)

        label_font = ("Tajawal", 16, "bold")
        entry_font = ("Tajawal", 15)

        # Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        tk.Label(
            inner_info,
            text="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:",
            font=label_font,
            bg=self.COLORS["surface"],
            fg=self.COLORS["dark"]
        ).grid(row=0, column=0, sticky=tk.E, pady=15, padx=(0, 20))

        program_number_entry = tk.Entry(inner_info, font=entry_font, width=25)
        program_number_entry.grid(row=0, column=1, sticky=tk.W, pady=15)

        # Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ø¨Ø­Ø«
        tk.Label(
            inner_info,
            text="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=label_font,
            bg=self.COLORS["surface"],
            fg=self.COLORS["dark"]
        ).grid(row=0, column=2, sticky=tk.E, pady=15, padx=(50, 20))

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª
        cursor = self.db_conn.cursor()
        cursor.execute("SELECT id, name FROM course_names WHERE is_active = 1 ORDER BY name")
        courses = cursor.fetchall()
        course_names = [course[1] for course in courses] if courses else ["Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ±Ø§Øª Ù…Ø³Ø¬Ù„Ø©"]
        course_ids = {course[1]: course[0] for course in courses}

        # Ø¥Ø·Ø§Ø± Ù„Ù„Ø¯ÙˆØ±Ø©
        course_frame = tk.Frame(inner_info, bg=self.COLORS["surface"])
        course_frame.grid(row=0, column=3, sticky=tk.W, pady=15)

        course_var = tk.StringVar(master=add_window)

        # Entry Ù„Ù„Ø¨Ø­Ø«
        course_entry = tk.Entry(course_frame, font=entry_font, width=35)
        course_entry.pack(side=tk.LEFT)

        # Ø¥Ø·Ø§Ø± Ù„Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
        suggestions_frame = tk.Frame(add_window, bg="white", relief=tk.RAISED, bd=1)

        def update_suggestions(event=None):
            """ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª"""
            typed_text = course_entry.get().lower()

            if not typed_text:
                suggestions_frame.place_forget()
                return

            filtered = [name for name in course_names if typed_text in name.lower()]

            if not filtered:
                suggestions_frame.place_forget()
                return

            for widget in suggestions_frame.winfo_children():
                widget.destroy()

            for i, suggestion in enumerate(filtered[:10]):
                btn = tk.Button(
                    suggestions_frame,
                    text=suggestion,
                    font=entry_font,
                    bg="white",
                    fg="black",
                    bd=0,
                    anchor=tk.W,
                    padx=10,
                    pady=5,
                    cursor="hand2",
                    command=lambda s=suggestion: select_course(s)
                )
                btn.pack(fill=tk.X)

                btn.bind("<Enter>", lambda e, b=btn: b.config(bg="#e3f2fd"))
                btn.bind("<Leave>", lambda e, b=btn: b.config(bg="white"))

            course_entry.update_idletasks()
            x = course_entry.winfo_rootx()
            y = course_entry.winfo_rooty() + course_entry.winfo_height()
            suggestions_frame.place(x=x, y=y, width=course_entry.winfo_width())

        def select_course(course_name):
            """Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª"""
            course_entry.delete(0, tk.END)
            course_entry.insert(0, course_name)
            course_var.set(course_name)
            suggestions_frame.place_forget()
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ®ØµØµÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©
            update_available_subjects()

        course_entry.bind('<KeyRelease>', update_suggestions)
        course_entry.bind('<FocusOut>', lambda e: add_window.after(200, suggestions_frame.place_forget))

        # Ø²Ø± Ø¥Ø¶Ø§ÙØ©
        tk.Button(
            course_frame,
            text="+",
            font=("Tajawal", 14, "bold"),
            bg=self.COLORS["secondary"],
            fg="white",
            bd=0,
            width=3,
            cursor="hand2",
            command=lambda: self._quick_add_course_name(add_window, course_entry, course_names)
        ).pack(side=tk.LEFT, padx=(5, 0))

        # Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
        tk.Label(
            inner_info,
            text="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:",
            font=label_font,
            bg=self.COLORS["surface"],
            fg=self.COLORS["dark"]
        ).grid(row=1, column=0, sticky=tk.E, pady=15, padx=(0, 20))

        from tkcalendar import DateEntry
        start_date_entry = DateEntry(
            inner_info,
            font=entry_font,
            date_pattern='yyyy-mm-dd',
            width=15
        )
        start_date_entry.grid(row=1, column=1, sticky=tk.W, pady=15)

        tk.Label(
            inner_info,
            text="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:",
            font=label_font,
            bg=self.COLORS["surface"],
            fg=self.COLORS["dark"]
        ).grid(row=1, column=2, sticky=tk.E, pady=15, padx=(50, 20))

        end_date_entry = DateEntry(
            inner_info,
            font=entry_font,
            date_pattern='yyyy-mm-dd',
            width=15
        )
        end_date_entry.grid(row=1, column=3, sticky=tk.W, pady=15)

        # ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©
        tk.Label(
            inner_info,
            text="ÙØ¦Ø© Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=label_font,
            bg=self.COLORS["surface"],
            fg=self.COLORS["dark"]
        ).grid(row=2, column=0, sticky=tk.E, pady=15, padx=(0, 20))

        categories = ["Ø¶Ø¨Ø§Ø·", "Ø£ÙØ±Ø§Ø¯", "Ù…Ø´ØªØ±ÙƒØ©", "Ù…Ø¯Ù†ÙŠÙŠÙ†"]
        category_var = tk.StringVar(master=add_window, value=categories[0])
        category_combo = ttk.Combobox(
            inner_info,
            textvariable=category_var,
            values=categories,
            font=entry_font,
            width=20,
            state="readonly"
        )
        category_combo.grid(row=2, column=1, sticky=tk.W, pady=15)

        # Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©
        available_general_subjects = []
        available_specialized_subjects = []

        def update_available_subjects():
            """ØªØ­Ø¯ÙŠØ« Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©"""
            nonlocal available_general_subjects, available_specialized_subjects

            cursor = self.db_conn.cursor()

            # Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø©
            cursor.execute("SELECT subject_name FROM general_subjects ORDER BY subject_name")
            available_general_subjects = [s[0] for s in cursor.fetchall()]

            # Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ®ØµØµÙŠØ© Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            course_name = course_entry.get().strip()
            if course_name:
                cursor.execute("""
                    SELECT subject_name FROM specialized_subjects 
                    WHERE course_name = ? 
                    ORDER BY subject_name
                """, (course_name,))
                available_specialized_subjects = [s[0] for s in cursor.fetchall()]
            else:
                available_specialized_subjects = []

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯
        subjects_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], relief=tk.RIDGE, bd=2)
        subjects_frame.pack(fill=tk.BOTH, expand=True)

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯
        subjects_header = tk.Frame(subjects_frame, bg="#1E3A5F", height=60)
        subjects_header.pack(fill=tk.X)
        subjects_header.pack_propagate(False)

        header_content_frame = tk.Frame(subjects_header, bg="#1E3A5F")
        header_content_frame.pack(expand=True)

        tk.Label(
            header_content_frame,
            text="Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ",
            font=("Tajawal", 20, "bold"),
            bg="#1E3A5F",
            fg="white"
        ).pack()

        # Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ§Ø¯
        add_subjects_frame = tk.Frame(subjects_frame, bg=self.COLORS["surface"])
        add_subjects_frame.pack(fill=tk.X, padx=30, pady=15)

        tk.Button(
            add_subjects_frame,
            text="+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¹Ø§Ù…Ø©",
            font=("Tajawal", 14, "bold"),
            bg="#FF9800",
            fg="white",
            bd=0,
            padx=20,
            pady=10,
            cursor="hand2",
            command=lambda: add_subject("general")
        ).pack(side=tk.LEFT, padx=(0, 10))

        tk.Button(
            add_subjects_frame,
            text="+ Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ØªØ®ØµØµÙŠØ©",
            font=("Tajawal", 14, "bold"),
            bg="#9C27B0",
            fg="white",
            bd=0,
            padx=20,
            pady=10,
            cursor="hand2",
            command=lambda: add_subject("specialized")
        ).pack(side=tk.LEFT)

        # Ø¥Ø·Ø§Ø± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù…ÙˆØ§Ø¯
        subjects_container = tk.Frame(subjects_frame, bg=self.COLORS["surface"])
        subjects_container.pack(fill=tk.BOTH, expand=True, padx=30, pady=(0, 20))

        # Canvas Ù„Ù„ØªÙ…Ø±ÙŠØ±
        canvas = tk.Canvas(subjects_container, bg=self.COLORS["surface"], highlightthickness=0)
        scrollbar = ttk.Scrollbar(subjects_container, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg=self.COLORS["surface"])

        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )

        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)

        subjects_entries = []

        def add_subject(category_type="general"):
            """Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©"""
            update_available_subjects()

            subject_frame = tk.Frame(scrollable_frame, bg=self.COLORS["surface"], pady=8)
            subject_frame.pack(fill=tk.X, padx=20)

            num = len(subjects_entries) + 1

            # Ù„ÙˆÙ† Ù…Ø®ØªÙ„Ù Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©
            color = "#FF9800" if category_type == "general" else "#9C27B0"

            num_label = tk.Label(
                subject_frame,
                text=f"Ø§Ù„Ù…Ø§Ø¯Ø© {num}:",
                font=("Tajawal", 15, "bold"),
                bg=self.COLORS["surface"],
                fg=color,
                width=10
            )
            num_label.pack(side=tk.LEFT, padx=(0, 15))

            # Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©
            type_label = tk.Label(
                subject_frame,
                text=f"({category_type == 'general' and 'Ø¹Ø§Ù…Ø©' or 'ØªØ®ØµØµÙŠØ©'})",
                font=("Tajawal", 12),
                bg=self.COLORS["surface"],
                fg=color
            )
            type_label.pack(side=tk.LEFT, padx=(0, 15))

            # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            entry_frame = tk.Frame(subject_frame, bg=self.COLORS["surface"])
            entry_frame.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(0, 15))

            subject_entry = tk.Entry(
                entry_frame,
                font=("Tajawal", 14),
                width=50
            )
            subject_entry.pack(side=tk.LEFT, fill=tk.X, expand=True)

            # Ø¥Ø·Ø§Ø± Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ù„Ù„Ù…Ø§Ø¯Ø©
            subject_suggestions_frame = tk.Frame(add_window, bg="white", relief=tk.RAISED, bd=1)

            def update_subject_suggestions(event=None):
                """ØªØ­Ø¯ÙŠØ« Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯"""
                typed_text = subject_entry.get().lower()

                # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
                if category_type == "general":
                    available_subjects = available_general_subjects
                else:
                    available_subjects = available_specialized_subjects

                if not typed_text or not available_subjects:
                    subject_suggestions_frame.place_forget()
                    return

                filtered = [name for name in available_subjects if typed_text in name.lower()]

                if not filtered:
                    subject_suggestions_frame.place_forget()
                    return

                for widget in subject_suggestions_frame.winfo_children():
                    widget.destroy()

                for i, suggestion in enumerate(filtered[:10]):
                    btn = tk.Button(
                        subject_suggestions_frame,
                        text=suggestion,
                        font=("Tajawal", 13),
                        bg="white",
                        fg="black",
                        bd=0,
                        anchor=tk.W,
                        padx=10,
                        pady=5,
                        cursor="hand2",
                        command=lambda s=suggestion: select_subject(s)
                    )
                    btn.pack(fill=tk.X)

                    btn.bind("<Enter>", lambda e, b=btn: b.config(bg="#e3f2fd"))
                    btn.bind("<Leave>", lambda e, b=btn: b.config(bg="white"))

                subject_entry.update_idletasks()
                x = subject_entry.winfo_rootx()
                y = subject_entry.winfo_rooty() + subject_entry.winfo_height()
                subject_suggestions_frame.place(x=x, y=y, width=subject_entry.winfo_width())

            def select_subject(subject_name):
                """Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª"""
                subject_entry.delete(0, tk.END)
                subject_entry.insert(0, subject_name)
                subject_suggestions_frame.place_forget()

            subject_entry.bind('<KeyRelease>', update_subject_suggestions)
            subject_entry.bind('<FocusOut>', lambda e: add_window.after(200, subject_suggestions_frame.place_forget))

            def remove_this():
                subject_frame.destroy()
                # Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹
                for i, (entry, cat_type) in enumerate(subjects_entries):
                    if entry == subject_entry:
                        subjects_entries.pop(i)
                        break
                # Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ø¯
                for i, (entry, cat_type) in enumerate(subjects_entries):
                    parent = entry.master.master
                    label = parent.winfo_children()[0]
                    label.config(text=f"Ø§Ù„Ù…Ø§Ø¯Ø© {i + 1}:")

            remove_btn = tk.Button(
                subject_frame,
                text="Ø­Ø°Ù",
                font=("Tajawal", 12, "bold"),
                bg=self.COLORS["danger"],
                fg="white",
                bd=0,
                padx=15,
                pady=8,
                cursor="hand2",
                command=remove_this
            )
            remove_btn.pack(side=tk.RIGHT)

            subjects_entries.append((subject_entry, category_type))
            canvas.update_idletasks()
            canvas.yview_moveto(1.0)

        # Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ø§Ù…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
        add_subject("general")

        canvas.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø©
        update_available_subjects()

    def _quick_add_course_name(self, parent_window, combo_widget, courses_list):
        """Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ù…Ù‰ Ø¯ÙˆØ±Ø© Ø³Ø±ÙŠØ¹"""
        dialog = tk.Toplevel(parent_window)
        dialog.title("Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ù…Ù‰ Ø¯ÙˆØ±Ø©")
        dialog.geometry("400x200")
        dialog.configure(bg=self.COLORS["surface"])
        dialog.transient(parent_window)
        dialog.grab_set()

        # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
        dialog.update_idletasks()
        x = (dialog.winfo_screenwidth() - 400) // 2
        y = (dialog.winfo_screenheight() - 200) // 2
        dialog.geometry(f"400x200+{x}+{y}")

        # Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        content = tk.Frame(dialog, bg=self.COLORS["surface"], padx=30, pady=30)
        content.pack(fill=tk.BOTH, expand=True)

        tk.Label(
            content,
            text="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["surface"]
        ).pack(anchor=tk.W, pady=(0, 10))

        name_entry = tk.Entry(content, font=self.FONTS["text"], width=35)
        name_entry.pack(fill=tk.X, pady=(0, 20))
        name_entry.focus_set()

        def save_course():
            name = name_entry.get().strip()
            if not name:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©")
                return

            try:
                cursor = self.db_conn.cursor()
                cursor.execute("""
                    INSERT INTO course_names (name, description, created_date)
                    VALUES (?, '', ?)
                """, (name, datetime.now().strftime("%Y-%m-%d")))

                self.db_conn.commit()

                # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                courses_list.append(name)
                combo_widget['values'] = courses_list
                combo_widget.set(name)

                dialog.destroy()
                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ù…Ù‰ Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­")

            except sqlite3.IntegrityError:
                messagebox.showerror("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹")
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

        # Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        btn_frame = tk.Frame(content, bg=self.COLORS["surface"])
        btn_frame.pack(fill=tk.X)

        tk.Button(
            btn_frame,
            text="Ø­ÙØ¸",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["success"],
            fg="white",
            bd=0,
            padx=20,
            pady=8,
            cursor="hand2",
            command=save_course
        ).pack(side=tk.LEFT)

        tk.Button(
            btn_frame,
            text="Ø¥Ù„ØºØ§Ø¡",
            font=self.FONTS["text_bold"],
            bg=self.COLORS["danger"],
            fg="white",
            bd=0,
            padx=20,
            pady=8,
            cursor="hand2",
            command=dialog.destroy
        ).pack(side=tk.RIGHT)

        # Ø±Ø¨Ø· Enter Ù„Ù„Ø­ÙØ¸
        name_entry.bind('<Return>', lambda e: save_course())

    def _load_training_programs(self):
        """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©"""
        # Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        for item in self.programs_tree.get_children():
            self.programs_tree.delete(item)

        try:
            cursor = self.db_conn.cursor()

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ is_archived
            cursor.execute("PRAGMA table_info(training_programs)")
            columns = [column[1] for column in cursor.fetchall()]

            if 'is_archived' in columns:
                # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                cursor.execute("""
                    SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                           tp.end_date, tp.category,
                           (SELECT COUNT(*) FROM program_subjects WHERE program_id = tp.id) as subject_count
                    FROM training_programs tp
                    LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                    WHERE COALESCE(tp.is_archived, 0) = 0
                    ORDER BY tp.start_date DESC
                """)
            else:
                # Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                cursor.execute("""
                    SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                           tp.end_date, tp.category,
                           (SELECT COUNT(*) FROM program_subjects WHERE program_id = tp.id) as subject_count
                    FROM training_programs tp
                    LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                    ORDER BY tp.start_date DESC
                """)

            programs = cursor.fetchall()

            for index, program in enumerate(programs):
                # Ø¥Ø²Ø§Ù„Ø© id Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
                display_data = program[1:]  # ØªØ®Ø·ÙŠ id
                tag = 'evenrow' if index % 2 == 0 else 'oddrow'
                item = self.programs_tree.insert("", tk.END, values=display_data,
                                                 tags=(tag, f"id_{program[0]}"))

            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
            if hasattr(self, 'program_count_label'):
                self.program_count_label.config(text=f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©: {len(programs)}")

        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬: {e}")
            # ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±
            try:
                cursor.execute("""
                    SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                           tp.end_date, tp.category,
                           (SELECT COUNT(*) FROM program_subjects WHERE program_id = tp.id) as subject_count
                    FROM training_programs tp
                    LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                    ORDER BY tp.start_date DESC
                """)

                programs = cursor.fetchall()

                for index, program in enumerate(programs):
                    display_data = program[1:]
                    tag = 'evenrow' if index % 2 == 0 else 'oddrow'
                    item = self.programs_tree.insert("", tk.END, values=display_data,
                                                     tags=(tag, f"id_{program[0]}"))

                if hasattr(self, 'program_count_label'):
                    self.program_count_label.config(text=f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©: {len(programs)}")

            except Exception as e2:
                print(f"Ø®Ø·Ø£ Ù†Ù‡Ø§Ø¦ÙŠ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬: {e2}")

    def _search_programs(self):
        """Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©"""
        search_text = self.program_search_entry.get().strip()

        # Ù…Ø³Ø­ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        for item in self.programs_tree.get_children():
            self.programs_tree.delete(item)

        try:
            cursor = self.db_conn.cursor()

            if search_text:
                cursor.execute("""
                    SELECT tp.id, tp.program_number, cn.name, tp.start_date, 
                           tp.end_date, tp.category,
                           (SELECT COUNT(*) FROM program_subjects WHERE program_id = tp.id) as subject_count
                    FROM training_programs tp
                    LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                    WHERE tp.program_number LIKE ? OR cn.name LIKE ?
                    ORDER BY tp.start_date DESC
                """, (f'%{search_text}%', f'%{search_text}%'))
            else:
                self._load_training_programs()
                return

            programs = cursor.fetchall()

            for index, program in enumerate(programs):
                display_data = program[1:]
                tag = 'evenrow' if index % 2 == 0 else 'oddrow'
                item = self.programs_tree.insert("", tk.END, values=display_data,
                                                 tags=(tag, f"id_{program[0]}"))

        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«: {e}")

    # 1. ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© _show_program_details Ù„ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±
    def _show_program_details(self, event):
        """Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ù…Ø¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ - Ù…Ø¹ ØªÙ…Ø±ÙŠØ± Ø§Ù„ÙØµÙ„ Ù„Ù„ØªØµØ¯ÙŠØ±"""
        selection = self.programs_tree.selection()
        if not selection:
            return

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ id Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ù† tags
        item = self.programs_tree.item(selection[0])
        tags = item['tags']
        program_id = None
        for tag in tags:
            if tag.startswith('id_'):
                program_id = int(tag.split('_')[1])
                break

        if not program_id:
            return

        # Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ - Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø©
        detail_window = tk.Toplevel(self)
        detail_window.title("ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„")
        detail_window.state('zoomed')
        detail_window.configure(bg=self.COLORS["background"])
        detail_window.transient(self)
        detail_window.grab_set()

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        cursor = self.db_conn.cursor()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        cursor.execute("PRAGMA table_info(training_programs)")
        columns = [column[1] for column in cursor.fetchall()]

        if 'has_classes' in columns and 'classes_count' in columns:
            cursor.execute("""
                SELECT tp.program_number, cn.name, tp.start_date, tp.end_date, tp.category,
                       tp.has_classes, tp.classes_count
                FROM training_programs tp
                LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                WHERE tp.id = ?
            """, (program_id,))
        else:
            cursor.execute("""
                SELECT tp.program_number, cn.name, tp.start_date, tp.end_date, tp.category
                FROM training_programs tp
                LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                WHERE tp.id = ?
            """, (program_id,))

        program = cursor.fetchone()

        has_classes = program[5] if len(program) > 5 else 0
        classes_count = program[6] if len(program) > 6 else 1

        # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
        from datetime import datetime
        start_date = datetime.strptime(program[2], "%Y-%m-%d")
        end_date = datetime.strptime(program[3], "%Y-%m-%d")
        weeks = ((end_date - start_date).days // 7) + 1

        # Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ­ÙƒÙ…
        selected_week = tk.IntVar(value=1)
        selected_class = tk.IntVar(value=1)

        # Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        header_frame = tk.Frame(detail_window, bg="#1E3A5F", height=80)
        header_frame.pack(fill=tk.X)
        header_frame.pack_propagate(False)

        header_content = tk.Frame(header_frame, bg="#1E3A5F")
        header_content.pack(expand=True, fill=tk.BOTH, padx=30)

        title_label = tk.Label(
            header_content,
            text=f"Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ: {program[0]} - {program[1]}",
            font=("Tajawal", 24, "bold"),
            bg="#1E3A5F",
            fg="white"
        )
        title_label.pack(side=tk.LEFT, pady=20)

        # Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        buttons_container = tk.Frame(header_content, bg="#1E3A5F")
        buttons_container.pack(side=tk.LEFT, pady=20)

        # Ø²Ø± ØªØµØ¯ÙŠØ± Ù„Ù„Ù…Ø¯Ø±Ø³ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙØµÙˆÙ„
        export_teacher_btn = tk.Button(
            buttons_container,
            text="ØªØµØ¯ÙŠØ± Ù„Ù„Ù…Ø¯Ø±Ø³",
            font=("Tajawal", 14, "bold"),
            bg="#17a2b8",
            fg="white",
            padx=20,
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._export_schedule_for_teacher(
                program_id,
                selected_week.get(),
                selected_class.get() if has_classes else 1
            )
        )
        export_teacher_btn.pack(side=tk.LEFT, padx=(0, 5))

        # Ø²Ø± ØªØµØ¯ÙŠØ± Ø¹Ø§Ù… Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙØµÙˆÙ„
        export_general_btn = tk.Button(
            buttons_container,
            text="ØªØµØ¯ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙƒØ§Ù…Ù„",
            font=("Tajawal", 14, "bold"),
            bg="#6c757d",
            fg="white",
            padx=20,
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._export_general_schedule(
                program_id,
                selected_week.get(),
                selected_class.get() if has_classes else 1
            )
        )
        export_general_btn.pack(side=tk.LEFT, padx=(0, 5))

        # Ø£Ø²Ø±Ø§Ø± Ø¥Ø¯Ø§Ø±Ø©
        buttons_container2 = tk.Frame(header_content, bg="#1E3A5F")
        buttons_container2.pack(side=tk.RIGHT, pady=20)

        # Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
        manage_schedule_btn = tk.Button(
            buttons_container2,
            text="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„",
            font=("Tajawal", 14, "bold"),
            bg="#28a745",
            fg="white",
            padx=25,
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=lambda: self._manage_program_schedule(program_id, program[0], detail_window)
        )
        manage_schedule_btn.pack(side=tk.LEFT, padx=(0, 10))

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        close_btn = tk.Button(
            buttons_container2,
            text="Ø¥ØºÙ„Ø§Ù‚",
            font=("Tajawal", 14, "bold"),
            bg="#dc3545",
            fg="white",
            padx=25,
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=detail_window.destroy
        )
        close_btn.pack(side=tk.LEFT)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        main_frame = tk.Frame(detail_window, bg=self.COLORS["background"])
        main_frame.pack(fill=tk.BOTH, expand=True, padx=15, pady=15)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        info_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], relief=tk.RIDGE, bd=1)
        info_frame.pack(fill=tk.X, pady=(0, 10))

        inner_info = tk.Frame(info_frame, bg=self.COLORS["surface"], padx=20, pady=15)
        inner_info.pack(fill=tk.X)

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯
        info_items = [
            ("Ø±Ù‚Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:", program[0]),
            ("Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©:", program[1]),
            ("Ø§Ù„ÙØ¦Ø©:", program[4]),
            ("Ù…Ù†:", program[2]),
            ("Ø¥Ù„Ù‰:", program[3]),
            ("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹:", f"{weeks} Ø£Ø³Ø§Ø¨ÙŠØ¹")
        ]

        if has_classes:
            info_items.append(("Ø¹Ø¯Ø¯ Ø§Ù„ÙØµÙˆÙ„:", f"{classes_count} ÙØµÙˆÙ„"))

        for i, (label, value) in enumerate(info_items):
            item_frame = tk.Frame(inner_info, bg=self.COLORS["surface"])
            item_frame.pack(side=tk.LEFT, expand=True, padx=5)

            tk.Label(
                item_frame,
                text=label,
                font=("Tajawal", 12, "bold"),
                bg=self.COLORS["surface"],
                fg="#1E3A5F"
            ).pack(side=tk.LEFT)

            tk.Label(
                item_frame,
                text=value,
                font=("Tajawal", 12),
                bg=self.COLORS["surface"],
                fg="#333"
            ).pack(side=tk.LEFT, padx=(5, 0))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ - Ø£ÙÙ‚ÙŠ Ø¨Ø³ÙŠØ·
        subjects_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], relief=tk.RIDGE, bd=1)
        subjects_frame.pack(fill=tk.X, pady=(0, 10))

        subjects_container = tk.Frame(subjects_frame, bg=self.COLORS["surface"], padx=15, pady=10)
        subjects_container.pack(fill=tk.X)

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¯
        tk.Label(
            subjects_container,
            text="Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:",
            font=("Tajawal", 13, "bold"),
            bg=self.COLORS["surface"],
            fg="#1E3A5F"
        ).pack(side=tk.LEFT, padx=(0, 15))

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯
        cursor.execute("""
            SELECT id, subject_name, subject_order 
            FROM program_subjects 
            WHERE program_id = ? AND subject_order != 999
            ORDER BY subject_order
        """, (program_id,))

        subjects = cursor.fetchall()

        # Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø£ÙÙ‚ÙŠØ§Ù‹
        for idx, subject in enumerate(subjects):
            if idx > 0:
                # ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯
                tk.Label(
                    subjects_container,
                    text=" | ",
                    font=("Tajawal", 13),
                    bg=self.COLORS["surface"],
                    fg="#999"
                ).pack(side=tk.LEFT)

            # Ø§Ù„Ù…Ø§Ø¯Ø©
            tk.Label(
                subjects_container,
                text=f"{subject[2]}. {subject[1]}",
                font=("Tajawal", 13),
                bg=self.COLORS["surface"],
                fg="#333"
            ).pack(side=tk.LEFT, padx=5)

        # Ø¥Ø·Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„ÙØµÙ„
        week_selector_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], height=50)
        week_selector_frame.pack(fill=tk.X, pady=(0, 10))
        week_selector_frame.pack_propagate(False)

        week_container = tk.Frame(week_selector_frame, bg=self.COLORS["surface"])
        week_container.pack(expand=True, fill=tk.BOTH, padx=20, pady=5)

        # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        tk.Label(
            week_container,
            text="Ø§Ø®ØªØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:",
            font=("Tajawal", 14, "bold"),
            bg=self.COLORS["surface"],
            fg="#1E3A5F"
        ).pack(side=tk.LEFT, padx=(0, 15))

        # Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
        weeks_buttons_frame = tk.Frame(week_container, bg=self.COLORS["surface"])
        weeks_buttons_frame.pack(side=tk.LEFT)

        week_buttons = []

        def show_week_schedule(week_num):
            """Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø£Ø³Ø¨ÙˆØ¹ Ù…Ø­Ø¯Ø¯"""
            selected_week.set(week_num)

            # ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            for i, btn in enumerate(week_buttons):
                if i + 1 == week_num:
                    btn.config(bg="#1E3A5F", fg="white")
                else:
                    btn.config(bg="#E0E0E0", fg="black")

            # ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            for widget in schedule_container.winfo_children():
                widget.destroy()
            self._create_schedule_view(
                schedule_container, program_id,
                week_number=week_num,
                class_number=selected_class.get() if has_classes else 1,
                readonly=True
            )

        # Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
        for week in range(1, weeks + 1):
            week_btn = tk.Button(
                weeks_buttons_frame,
                text=f"Ø£Ø³Ø¨ÙˆØ¹ {week}",
                font=("Tajawal", 11, "bold"),
                bg="#E0E0E0" if week != 1 else "#1E3A5F",
                fg="black" if week != 1 else "white",
                width=9,
                height=1,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=lambda w=week: show_week_schedule(w)
            )
            week_btn.pack(side=tk.LEFT, padx=3)
            week_buttons.append(week_btn)

            # ØªØ£Ø«ÙŠØ±Ø§Øª hover
            def on_enter(e, btn=week_btn, week_num=week):
                if selected_week.get() != week_num:
                    btn.config(bg="#BDBDBD")

            def on_leave(e, btn=week_btn, week_num=week):
                if selected_week.get() == week_num:
                    btn.config(bg="#1E3A5F", fg="white")
                else:
                    btn.config(bg="#E0E0E0", fg="black")

            week_btn.bind("<Enter>", on_enter)
            week_btn.bind("<Leave>", on_leave)

        # Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„ÙØµÙˆÙ„ Ø¥Ù† ÙˆØ¬Ø¯Øª
        if has_classes:
            # Ø¥Ø¶Ø§ÙØ© ÙØ§ØµÙ„
            tk.Label(
                week_container,
                text=" | ",
                font=("Tajawal", 14),
                bg=self.COLORS["surface"],
                fg="#999"
            ).pack(side=tk.LEFT, padx=20)

            # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙØµÙ„
            tk.Label(
                week_container,
                text="Ø§Ù„ÙØµÙ„:",
                font=("Tajawal", 14, "bold"),
                bg=self.COLORS["surface"],
                fg="#FF6B35"
            ).pack(side=tk.LEFT, padx=(0, 10))

            # Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„ÙØµÙˆÙ„
            class_names = [f"ÙØµÙ„ {i}" for i in range(1, classes_count + 1)]

            class_combo = ttk.Combobox(
                week_container,
                values=class_names,
                font=("Tajawal", 12, "bold"),
                state="readonly",
                width=12
            )
            class_combo.current(0)
            class_combo.pack(side=tk.LEFT)

            def on_class_change(event):
                """Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙØµÙ„"""
                selected_text = class_combo.get()
                class_num = int(selected_text.split()[1])
                selected_class.set(class_num)

                # ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                for widget in schedule_container.winfo_children():
                    widget.destroy()
                self._create_schedule_view(
                    schedule_container, program_id,
                    week_number=selected_week.get(),
                    class_number=class_num,
                    readonly=True
                )

            class_combo.bind('<<ComboboxSelected>>', on_class_change)

        # Ø®Ø· ÙØ§ØµÙ„
        separator = tk.Frame(main_frame, bg=self.COLORS["border"], height=2)
        separator.pack(fill=tk.X, padx=15, pady=(0, 10))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ù…Ù„Ø¡ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
        schedule_frame = tk.Frame(main_frame, bg=self.COLORS["surface"], relief=tk.RIDGE, bd=1)
        schedule_frame.pack(fill=tk.BOTH, expand=True)

        schedule_header = tk.Frame(schedule_frame, bg="#1E3A5F", height=35)
        schedule_header.pack(fill=tk.X)
        schedule_header.pack_propagate(False)

        tk.Label(
            schedule_header,
            text="Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ",
            font=("Tajawal", 14, "bold"),
            bg="#1E3A5F",
            fg="white"
        ).pack(expand=True)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
        schedule_container = tk.Frame(schedule_frame, bg="white", padx=10, pady=10)
        schedule_container.pack(fill=tk.BOTH, expand=True)

        # Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
        show_week_schedule(1)

    # ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ù„Ø© _create_schedule_view Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© parent_window
    def _create_schedule_view(self, parent_frame, program_id, week_number=1, class_number=1, readonly=False):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙØµÙˆÙ„ ÙˆÙ†Ø³Ø® Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶"""
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        cursor = self.db_conn.cursor()
        cursor.execute("SELECT schedule_type FROM training_programs WHERE id = ?", (program_id,))
        result = cursor.fetchone()
        schedule_type = result[0] if result and result[0] else "multiple"

        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ­Ø¯ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1 Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if schedule_type == "single":
            data_week = 1
        else:
            data_week = week_number

        # Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        days = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"]

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø­ØµØµ
        cursor.execute("""
            SELECT period_number, start_time, end_time
            FROM default_periods
            WHERE is_break = 0
            ORDER BY period_number
        """)
        periods = cursor.fetchall()

        # Ø¥Ø·Ø§Ø± Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªÙˆØ³ÙŠØ·
        center_frame = tk.Frame(parent_frame, bg=self.COLORS["background"])
        center_frame.pack(fill=tk.BOTH, expand=True)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
        table_frame = tk.Frame(center_frame, bg="white", relief=tk.GROOVE, bd=2)
        table_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=10)

        # Ø¹ÙƒØ³ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„Ù„Ø¹Ø±Ø¨ÙŠØ© - Ø§Ù„Ø£ÙŠØ§Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†
        col_index = len(periods)

        # Ø®Ù„ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„ÙØµÙ„ ÙÙŠ Ø§Ù„Ø²Ø§ÙˆÙŠØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ Ø§Ù„Ø¹Ù„ÙŠØ§
        week_text = f"Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ {week_number}"
        if class_number > 1:
            week_text += f"\nÙØµÙ„ {class_number}"

        week_label = tk.Label(
            table_frame,
            text=week_text,
            font=("Tajawal", 14, "bold"),
            bg="#F5F5F5",
            fg="black",
            relief=tk.GROOVE,
            bd=1,
            width=12
        )
        week_label.grid(row=0, column=col_index, sticky="nsew", rowspan=2)

        # Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø­ØµØµ (Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±)
        for idx, period in enumerate(periods):
            col = col_index - idx - 1

            # Ø§Ù„Ø­ØµØ©
            period_label = tk.Label(
                table_frame,
                text=f"Ø§Ù„Ø­ØµØ© {period[0]}",
                font=("Tajawal", 12, "bold"),
                bg="#F5F5F5",
                fg="black",
                relief=tk.GROOVE,
                bd=1
            )
            period_label.grid(row=0, column=col, sticky="nsew")

            # Ø§Ù„ÙˆÙ‚Øª
            time_label = tk.Label(
                table_frame,
                text=f"{period[1]} - {period[2]}",
                font=("Tajawal", 10),
                bg="#FAFAFA",
                fg="#555555",
                relief=tk.GROOVE,
                bd=1
            )
            time_label.grid(row=1, column=col, sticky="nsew")

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        cursor.execute("PRAGMA table_info(program_schedule)")
        columns = [column[1] for column in cursor.fetchall()]
        has_subject_type = 'subject_type' in columns
        has_class_number = 'class_number' in columns

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
        if has_class_number:
            if has_subject_type:
                cursor.execute("""
                    SELECT ps.day_of_week, ps.period_number, ps.subject_id, ps.teacher_id,
                           ps.teacher_name, psub.subject_name, t.name as teacher_db_name,
                           ps.subject_type
                    FROM program_schedule ps
                    LEFT JOIN program_subjects psub ON ps.subject_id = psub.id
                    LEFT JOIN teachers t ON ps.teacher_id = t.id
                    WHERE ps.program_id = ? AND ps.week_number = ? AND ps.class_number = ?
                    ORDER BY ps.day_of_week, ps.period_number
                """, (program_id, data_week, class_number))
            else:
                cursor.execute("""
                    SELECT ps.day_of_week, ps.period_number, ps.subject_id, ps.teacher_id,
                           ps.teacher_name, psub.subject_name, t.name as teacher_db_name,
                           'Ù†Ø¸Ø±ÙŠ' as subject_type
                    FROM program_schedule ps
                    LEFT JOIN program_subjects psub ON ps.subject_id = psub.id
                    LEFT JOIN teachers t ON ps.teacher_id = t.id
                    WHERE ps.program_id = ? AND ps.week_number = ? AND ps.class_number = ?
                    ORDER BY ps.day_of_week, ps.period_number
                """, (program_id, data_week, class_number))
        else:
            if has_subject_type:
                cursor.execute("""
                    SELECT ps.day_of_week, ps.period_number, ps.subject_id, ps.teacher_id,
                           ps.teacher_name, psub.subject_name, t.name as teacher_db_name,
                           ps.subject_type
                    FROM program_schedule ps
                    LEFT JOIN program_subjects psub ON ps.subject_id = psub.id
                    LEFT JOIN teachers t ON ps.teacher_id = t.id
                    WHERE ps.program_id = ? AND ps.week_number = ?
                    ORDER BY ps.day_of_week, ps.period_number
                """, (program_id, data_week))
            else:
                cursor.execute("""
                    SELECT ps.day_of_week, ps.period_number, ps.subject_id, ps.teacher_id,
                           ps.teacher_name, psub.subject_name, t.name as teacher_db_name,
                           'Ù†Ø¸Ø±ÙŠ' as subject_type
                    FROM program_schedule ps
                    LEFT JOIN program_subjects psub ON ps.subject_id = psub.id
                    LEFT JOIN teachers t ON ps.teacher_id = t.id
                    WHERE ps.program_id = ? AND ps.week_number = ?
                    ORDER BY ps.day_of_week, ps.period_number
                """, (program_id, data_week))

        schedule_data = {}
        for row in cursor.fetchall():
            day = row[0]
            period = row[1]
            schedule_data[(day, period)] = {
                'subject_id': row[2],
                'teacher_id': row[3],
                'teacher_name': row[4],
                'subject': row[5],
                'teacher_db': row[6],
                'subject_type': row[7] if len(row) > 7 else 'Ù†Ø¸Ø±ÙŠ'
            }

        # Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø­ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶
        def copy_to_next_period(from_day, from_period):
            """Ù†Ø³Ø® Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶"""
            # ØªØ¹Ø±ÙŠÙ cursor ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¯Ø§Ù„Ø©
            cursor = self.db_conn.cursor()

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¯ Ù†Ø³Ø®Ù‡Ø§
            source_data = schedule_data.get((from_day, from_period))
            if not source_data or not source_data.get('subject'):
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù†Ø³Ø® ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§Ù†Ø©")
                return

            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
            next_period = from_period + 1

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­ØµØ© ØªØ§Ù„ÙŠØ©
            if next_period > len(periods):
                messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØ© ØªØ§Ù„ÙŠØ© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…")
                return

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¯Ø±Ø³
            if source_data.get('teacher_id'):
                # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³
                cursor.execute("SELECT name, id_number FROM teachers WHERE id = ?", (source_data['teacher_id'],))
                teacher_info = cursor.fetchone()

                # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙØµÙˆÙ„
                has_conflict, conflict_details = self._check_teacher_conflict(
                    source_data['teacher_id'],
                    program_id,
                    data_week,
                    from_day,
                    next_period,
                    class_number
                )

                if has_conflict:
                    # Ø¨Ù†Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ø±Ø¶
                    conflict_msg = "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯Ø±Ø³ Ù„Ù„Ø­ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶:\n\n"

                    if teacher_info:
                        conflict_msg += f"Ø§Ù„Ù…Ø¯Ø±Ø³: {teacher_info[0]}\n"
                        conflict_msg += f"Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©: {teacher_info[1]}\n\n"

                    conflict_msg += "Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª:\n"
                    for conflict in conflict_details:
                        conflict_msg += f"â€¢ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: {conflict['program_number']}\n"
                        if 'class_number' in conflict and conflict['class_number'] > 1:
                            conflict_msg += f"  Ø§Ù„ÙØµÙ„: {conflict['class_number']}\n"
                        conflict_msg += f"  Ø§Ù„Ø¯ÙˆØ±Ø©: {conflict['course_name']}\n"
                        conflict_msg += f"  Ø§Ù„Ù…Ø§Ø¯Ø©: {conflict['subject_name']}\n"
                        conflict_msg += f"  Ø§Ù„ØªØ§Ø±ÙŠØ®: {conflict['date']}\n\n"

                    conflict_msg += "âš ï¸ Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªÙˆØ§Ø¬Ø¯ ÙÙŠ Ù…ÙƒØ§Ù†ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª."

                    messagebox.showerror("ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„", conflict_msg)
                    return

            try:
                cursor = self.db_conn.cursor()

                # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆÙ‚Øª Ø§Ù„Ø­ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ©
                cursor.execute("""
                    SELECT start_time, end_time FROM default_periods
                    WHERE period_number = ?
                """, (next_period,))
                time_info = cursor.fetchone()

                if time_info:
                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù…ÙˆØ¯ class_number
                    cursor.execute("PRAGMA table_info(program_schedule)")
                    columns = [column[1] for column in cursor.fetchall()]

                    if 'class_number' in columns:
                        # Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„
                        cursor.execute("""
                            INSERT OR REPLACE INTO program_schedule
                            (program_id, week_number, day_of_week, period_number,
                             start_time, end_time, subject_id, teacher_id,
                             subject_type, is_break, teacher_name, class_number)
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?, ?)
                        """, (
                            program_id, data_week, from_day, next_period,
                            time_info[0], time_info[1],
                            source_data['subject_id'],
                            source_data['teacher_id'],
                            source_data.get('subject_type', 'Ù†Ø¸Ø±ÙŠ'),
                            source_data['teacher_name'],
                            class_number
                        ))
                    else:
                        # Ù†Ø³Ø® Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… Ø§Ù„ÙØµÙ„ Ù„Ù„ØªÙˆØ§ÙÙ‚ÙŠØ©
                        cursor.execute("""
                            INSERT OR REPLACE INTO program_schedule
                            (program_id, week_number, day_of_week, period_number,
                             start_time, end_time, subject_id, teacher_id,
                             subject_type, is_break, teacher_name)
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, ?)
                        """, (
                            program_id, data_week, from_day, next_period,
                            time_info[0], time_info[1],
                            source_data['subject_id'],
                            source_data['teacher_id'],
                            source_data.get('subject_type', 'Ù†Ø¸Ø±ÙŠ'),
                            source_data['teacher_name']
                        ))

                    self.db_conn.commit()

                    # Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
                    for widget in center_frame.winfo_children():
                        widget.destroy()
                    self._create_schedule_view(center_frame, program_id, week_number=week_number,
                                               class_number=class_number,
                                               readonly=readonly)

                    messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­")

            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø³Ø®: {str(e)}")

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù…Ù† parent_frame
        parent_window = parent_frame.winfo_toplevel()

        # ØµÙÙˆÙ Ø§Ù„Ø£ÙŠØ§Ù…
        for row_idx, day_name in enumerate(days):
            # Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†
            day_label = tk.Label(
                table_frame,
                text=day_name,
                font=("Tajawal", 12, "bold"),
                bg="#F5F5F5",
                fg="black",
                relief=tk.GROOVE,
                bd=1,
                height=2
            )
            day_label.grid(row=row_idx + 2, column=col_index, sticky="nsew")

            # Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø­ØµØµ Ù„ÙƒÙ„ ÙŠÙˆÙ… (Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ù„ÙŠØ³Ø§Ø±)
            for idx, period in enumerate(periods):
                col = col_index - idx - 1
                period_num = period[0]
                cell_data = schedule_data.get((row_idx, period_num), {})

                # Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ù„ÙŠØ©
                cell = tk.Frame(table_frame, bg="white", relief=tk.GROOVE, bd=1)
                cell.grid(row=row_idx + 2, column=col, sticky="nsew", padx=0, pady=0)

                if cell_data.get('subject'):
                    # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ø¯Ø©
                    subject_label = tk.Label(
                        cell,
                        text=cell_data['subject'],
                        font=("Tajawal", 11, "bold"),
                        bg="white",
                        fg="black",
                        wraplength=140,
                        justify=tk.RIGHT
                    )
                    subject_label.pack(pady=(5, 2))

                    # Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©
                    subject_type = cell_data.get('subject_type', 'Ù†Ø¸Ø±ÙŠ')
                    type_color = "#2196F3" if subject_type == "Ø¹Ù…Ù„ÙŠ" else "#4CAF50"

                    type_label = tk.Label(
                        cell,
                        text=f"({subject_type})",
                        font=("Tajawal", 9, "bold"),
                        bg="white",
                        fg=type_color
                    )
                    type_label.pack(pady=(0, 2))

                    # Ø®Ø· ÙØ§ØµÙ„
                    separator = tk.Frame(cell, bg="#E0E0E0", height=1)
                    separator.pack(fill=tk.X, padx=15, pady=1)

                    # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ø±Ø³
                    if cell_data.get('teacher_name'):
                        teacher_text = cell_data['teacher_name']
                    elif cell_data.get('teacher_db'):
                        teacher_text = cell_data['teacher_db']
                    else:
                        teacher_text = "Ù„Ù… ÙŠØ­Ø¯Ø¯"

                    teacher_label = tk.Label(
                        cell,
                        text=teacher_text,
                        font=("Tajawal", 9),
                        bg="white",
                        fg="#555555",
                        wraplength=140,
                        justify=tk.RIGHT
                    )
                    teacher_label.pack(pady=(1, 5))

                    if not readonly and (schedule_type == "multiple" or week_number == 1):
                        # Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„Ø­Ø°Ù ÙˆØ§Ù„Ù†Ø³Ø®
                        btn_frame = tk.Frame(cell, bg="white")
                        btn_frame.pack(pady=1)

                        # Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ø­ØµØ© Ø§Ù„ØªØ§Ù„ÙŠØ© (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø©)
                        if period_num < len(periods):
                            copy_btn = tk.Button(
                                btn_frame,
                                text="Ù†Ø³Ø® Ù„Ù„ØªØ§Ù„ÙŠØ©",
                                font=("Tajawal", 8),
                                bg="#17a2b8",
                                fg="white",
                                bd=0,
                                padx=8,
                                pady=2,
                                cursor="hand2",
                                command=lambda d=row_idx, p=period_num: copy_to_next_period(d, p)
                            )
                            copy_btn.pack(side=tk.RIGHT, padx=2)

                        edit_btn = tk.Button(
                            btn_frame,
                            text="ØªØ¹Ø¯ÙŠÙ„",
                            font=("Tajawal", 8),
                            bg="#666666",
                            fg="white",
                            bd=0,
                            padx=8,
                            pady=2,
                            cursor="hand2",
                            command=lambda d=row_idx, p=period_num: self._show_assignment_options(
                                program_id, d, p, data_week, parent_window, class_number, edit_mode=True
                            )
                        )
                        edit_btn.pack(side=tk.RIGHT, padx=2)

                        delete_btn = tk.Button(
                            btn_frame,
                            text="Ø­Ø°Ù",
                            font=("Tajawal", 8),
                            bg="#999999",
                            fg="white",
                            bd=0,
                            padx=8,
                            pady=2,
                            cursor="hand2",
                            command=lambda d=row_idx, p=period_num: self._delete_schedule_slot(
                                program_id, d, p, data_week, class_number, center_frame
                            )
                        )
                        delete_btn.pack(side=tk.RIGHT, padx=2)

                elif not readonly and (schedule_type == "multiple" or week_number == 1):
                    # Ø²Ø± Ø¥Ø¶Ø§ÙØ©
                    add_btn = tk.Button(
                        cell,
                        text="+ Ø¥Ø¶Ø§ÙØ©",
                        font=("Tajawal", 10),
                        bg="#F5F5F5",
                        fg="#666666",
                        bd=0,
                        cursor="hand2",
                        relief=tk.FLAT,
                        command=lambda d=row_idx, p=period_num: self._show_assignment_options(
                            program_id, d, p, data_week, parent_window, class_number
                        )
                    )
                    add_btn.pack(expand=True, fill=tk.BOTH, padx=15, pady=20)

                    # ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ±
                    add_btn.bind("<Enter>", lambda e, btn=add_btn: btn.config(bg="#E0E0E0"))
                    add_btn.bind("<Leave>", lambda e, btn=add_btn: btn.config(bg="#F5F5F5"))

                # ØªÙƒÙˆÙŠÙ† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙ
                table_frame.grid_rowconfigure(row_idx + 2, minsize=100)

            # ØªÙƒÙˆÙŠÙ† Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            table_frame.grid_columnconfigure(col_index, minsize=100)  # Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ§Ù…
            for col in range(len(periods)):
                table_frame.grid_columnconfigure(col, minsize=180, weight=1)

            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ­Ø¯ØŒ Ø¹Ø±Ø¶ Ù…Ù„Ø§Ø­Ø¸Ø©
            if schedule_type == "single" and week_number != 1 and not readonly:
                note_label = tk.Label(
                    center_frame,
                    text="Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙŠØ³ØªØ®Ø¯Ù… Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ­Ø¯ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹",
                    font=("Tajawal", 12),
                    bg=self.COLORS["background"],
                    fg="#FF6B6B"
                )
                note_label.pack(pady=(0, 10))

    def _check_teacher_conflict(self, teacher_id, program_id, week_number, day_index, period_number, class_number=1):
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹Ø§Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© - Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„"""
        cursor = self.db_conn.cursor()

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³
        cursor.execute("SELECT id_number, name FROM teachers WHERE id = ?", (teacher_id,))
        teacher_info = cursor.fetchone()

        if not teacher_info:
            return False, None

        teacher_id_number = teacher_info[0]  # Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
        teacher_name = teacher_info[1]

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
        cursor.execute("""
            SELECT start_date, end_date, schedule_type 
            FROM training_programs 
            WHERE id = ?
        """, (program_id,))

        current_program_info = cursor.fetchone()
        from datetime import datetime, timedelta

        current_start = datetime.strptime(current_program_info[0], "%Y-%m-%d")
        current_end = datetime.strptime(current_program_info[1], "%Y-%m-%d")
        current_schedule_type = current_program_info[2] if len(current_program_info) > 2 else "multiple"

        # Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø­ØµØ© ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
        actual_date = current_start + timedelta(weeks=week_number - 1, days=day_index)

        conflicts_found = []

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        cursor.execute("PRAGMA table_info(program_schedule)")
        columns = [column[1] for column in cursor.fetchall()]
        has_class_number = 'class_number' in columns

        cursor.execute("PRAGMA table_info(training_programs)")
        tp_columns = [column[1] for column in cursor.fetchall()]
        has_is_archived = 'is_archived' in tp_columns
        has_schedule_type = 'schedule_type' in tp_columns

        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù†Ø´Ø·Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®
        query = """
            SELECT DISTINCT tp.id, tp.program_number, tp.start_date, tp.end_date
        """

        if has_schedule_type:
            query += ", tp.schedule_type"
        else:
            query += ", 'multiple' as schedule_type"

        query += """
            FROM training_programs tp
            WHERE tp.id != ?
        """

        if has_is_archived:
            query += " AND COALESCE(tp.is_archived, 0) = 0"

        query += " AND date(?) BETWEEN date(tp.start_date) AND date(tp.end_date)"

        cursor.execute(query, (program_id, actual_date.strftime("%Y-%m-%d")))
        active_programs = cursor.fetchall()

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª ÙÙŠ ÙƒÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù†Ø´Ø·
        for active_program in active_programs:
            other_program_id = active_program[0]
            other_program_number = active_program[1]
            other_start = datetime.strptime(active_program[2], "%Y-%m-%d")
            other_end = datetime.strptime(active_program[3], "%Y-%m-%d")
            other_schedule_type = active_program[4]

            # Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¢Ø®Ø±
            days_diff = (actual_date - other_start).days
            other_week_number = (days_diff // 7) + 1

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¢Ø®Ø±
            conflict_query = """
                SELECT ps.id, psub.subject_name, ps.class_number
                FROM program_schedule ps
                LEFT JOIN program_subjects psub ON ps.subject_id = psub.id
                JOIN teachers t ON ps.teacher_id = t.id
                WHERE ps.program_id = ?
                AND ps.day_of_week = ?
                AND ps.period_number = ?
                AND t.id_number = ?
            """

            # Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            if other_schedule_type == "single":
                # Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ­Ø¯ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1 ÙÙ‚Ø·
                conflict_query += " AND ps.week_number = 1"
                cursor.execute(conflict_query,
                               (other_program_id, day_index, period_number, teacher_id_number))
            else:
                # Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯
                conflict_query += " AND ps.week_number = ?"
                cursor.execute(conflict_query,
                               (other_program_id, day_index, period_number, teacher_id_number, other_week_number))

            conflict = cursor.fetchone()

            if conflict:
                # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©
                cursor.execute("""
                    SELECT cn.name 
                    FROM training_programs tp
                    LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                    WHERE tp.id = ?
                """, (other_program_id,))
                course_info = cursor.fetchone()

                conflict_dict = {
                    'program_id': other_program_id,
                    'program_number': other_program_number,
                    'course_name': course_info[0] if course_info else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                    'week_number': other_week_number,
                    'subject_name': conflict[1] if conflict[1] else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                    'date': actual_date.strftime("%Y-%m-%d"),
                    'day': day_index,
                    'period': period_number,
                    'class_number': conflict[2] if has_class_number and len(conflict) > 2 else 1
                }
                conflicts_found.append(conflict_dict)

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª Ù„Ù„Ø¬Ù‡Ø§Øª (teacher_name)
        for active_program in active_programs:
            other_program_id = active_program[0]
            other_program_number = active_program[1]
            other_start = datetime.strptime(active_program[2], "%Y-%m-%d")
            other_schedule_type = active_program[4]

            # Ø­Ø³Ø§Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙÙŠ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„Ø¢Ø®Ø±
            days_diff = (actual_date - other_start).days
            other_week_number = (days_diff // 7) + 1

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ù„Ù„Ø¬Ù‡Ø§Øª
            entity_query = """
                SELECT ps.id, psub.subject_name, ps.class_number
                FROM program_schedule ps
                LEFT JOIN program_subjects psub ON ps.subject_id = psub.id
                WHERE ps.program_id = ?
                AND ps.day_of_week = ?
                AND ps.period_number = ?
                AND ps.teacher_name = ?
                AND ps.teacher_id IS NULL
            """

            if other_schedule_type == "single":
                entity_query += " AND ps.week_number = 1"
                cursor.execute(entity_query,
                               (other_program_id, day_index, period_number, teacher_name))
            else:
                entity_query += " AND ps.week_number = ?"
                cursor.execute(entity_query,
                               (other_program_id, day_index, period_number, teacher_name, other_week_number))

            entity_conflict = cursor.fetchone()

            if entity_conflict:
                cursor.execute("""
                    SELECT cn.name 
                    FROM training_programs tp
                    LEFT JOIN course_names cn ON tp.course_name_id = cn.id
                    WHERE tp.id = ?
                """, (other_program_id,))
                course_info = cursor.fetchone()

                conflict_dict = {
                    'program_id': other_program_id,
                    'program_number': other_program_number,
                    'course_name': course_info[0] if course_info else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                    'week_number': other_week_number,
                    'subject_name': entity_conflict[1] if entity_conflict[1] else "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
                    'date': actual_date.strftime("%Y-%m-%d"),
                    'day': day_index,
                    'period': period_number,
                    'class_number': entity_conflict[2] if has_class_number and len(entity_conflict) > 2 else 1,
                    'is_entity': True
                }
                conflicts_found.append(conflict_dict)

        if conflicts_found:
            return True, conflicts_found

        return False, None

    # 7. Ø¯Ø§Ù„Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø¯Ø±Ø³ ÙˆÙ…Ø§Ø¯Ø© Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ÙØµÙˆÙ„ (ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
    def _assign_teacher_subject(self, program_id, day_index, period_number, week_number, class_number, parent_window):
        """ØªØ¹ÙŠÙŠÙ† Ù…Ø¯Ø±Ø³ ÙˆÙ…Ø§Ø¯Ø© Ù…Ø¹ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ®ØµØµÙŠØ© ÙˆØ¯Ø¹Ù… Ø§Ù„ÙØµÙˆÙ„"""
        assign_window = tk.Toplevel(parent_window)
        assign_window.title("Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³ ÙˆÙ…Ø§Ø¯Ø©")
        assign_window.geometry("700x800")
        assign_window.configure(bg=self.COLORS["surface"])
        assign_window.transient(parent_window)
        assign_window.grab_set()

        # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
        assign_window.update_idletasks()
        x = (assign_window.winfo_screenwidth() - 700) // 2
        y = (assign_window.winfo_screenheight() - 800) // 2
        assign_window.geometry(f"700x800+{x}+{y}")

        # Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        days = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"]

        cursor = self.db_conn.cursor()
        cursor.execute("""
            SELECT start_time, end_time FROM default_periods
            WHERE period_number = ?
        """, (period_number,))
        time_info = cursor.fetchone()

        header_text = f"Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ {week_number} - {days[day_index]}\nØ§Ù„Ø­ØµØ© {period_number} ({time_info[0]} - {time_info[1]})"
        if class_number > 1:
            header_text += f"\nÙØµÙ„ {class_number}"

        header = tk.Label(
            assign_window,
            text=header_text,
            font=("Tajawal", 16, "bold"),
            bg="#2196F3",
            fg="white",
            pady=20
        )
        header.pack(fill=tk.X)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        content = tk.Frame(assign_window, bg=self.COLORS["surface"], padx=30, pady=20)
        content.pack(fill=tk.BOTH, expand=True)

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©
        cursor.execute("""
            SELECT cn.name 
            FROM training_programs tp
            JOIN course_names cn ON tp.course_name_id = cn.id
            WHERE tp.id = ?
        """, (program_id,))
        course_info = cursor.fetchone()
        course_name = course_info[0] if course_info else None

        # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©
        tk.Label(
            content,
            text="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©:",
            font=("Tajawal", 14, "bold"),
            bg=self.COLORS["surface"]
        ).pack(anchor="w", pady=(0, 10))

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ø¹ ØªØµÙ†ÙŠÙÙ‡Ø§
        cursor.execute("""
            SELECT id, subject_name, subject_order, subject_category
            FROM program_subjects
            WHERE program_id = ? AND subject_order != 999
            ORDER BY subject_order
        """, (program_id,))

        subjects = cursor.fetchall()

        # Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
        selected_subject_id = tk.IntVar(value=0)
        selected_subject_category = tk.StringVar(value="general")

        subject_combo = ttk.Combobox(
            content,
            font=("Tajawal", 13),
            state="readonly",
            width=40
        )

        # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ù…Ø¹ ØªØµÙ†ÙŠÙÙ‡Ø§
        subject_list = []
        subject_map = {}

        for i, (sid, sname, sorder, scategory) in enumerate(subjects):
            category_text = " (Ø¹Ø§Ù…Ø©)" if scategory == "general" else " (ØªØ®ØµØµÙŠØ©)"
            text = f"{sorder}. {sname}{category_text}"
            subject_list.append(text)
            subject_map[i] = (sid, scategory or "general")

        subject_combo['values'] = subject_list
        subject_combo.pack(fill=tk.X, pady=(0, 20))

        # Ø§Ø®ØªÙŠØ§Ø± Ø£ÙˆÙ„ Ù…Ø§Ø¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
        if subject_list:
            subject_combo.current(0)
            selected_subject_id.set(subject_map[0][0])
            selected_subject_category.set(subject_map[0][1])

        # Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø§Ø¯Ø©
        def on_subject_change(event):
            index = subject_combo.current()
            if index >= 0:
                selected_subject_id.set(subject_map[index][0])
                selected_subject_category.set(subject_map[index][1])
                # ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©
                update_teachers_list()

        subject_combo.bind('<<ComboboxSelected>>', on_subject_change)

        # Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø© (Ø¹Ù…Ù„ÙŠ/Ù†Ø¸Ø±ÙŠ)
        tk.Label(
            content,
            text="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©:",
            font=("Tajawal", 14, "bold"),
            bg=self.COLORS["surface"]
        ).pack(anchor="w", pady=(0, 10))

        subject_type_combo = ttk.Combobox(
            content,
            values=["Ù†Ø¸Ø±ÙŠ", "Ø¹Ù…Ù„ÙŠ"],
            font=("Tajawal", 13),
            state="readonly",
            width=40
        )
        subject_type_combo.current(0)
        subject_type_combo.pack(fill=tk.X, pady=(0, 30))

        # Ø¥Ø·Ø§Ø± Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
        teacher_frame = tk.Frame(content, bg=self.COLORS["surface"])
        teacher_frame.pack(fill=tk.BOTH, expand=True)

        # Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ù…Ø®ØªØ§Ø±
        selected_teacher_id = tk.IntVar(value=0)
        teachers_map = {}

        # ØªØ³Ù…ÙŠØ© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ù„Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
        teacher_label = tk.Label(
            teacher_frame,
            text="",
            font=("Tajawal", 14, "bold"),
            bg=self.COLORS["surface"]
        )
        teacher_label.pack(anchor="w", pady=(0, 10))

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¨Ø­Ø«
        search_frame = tk.Frame(teacher_frame, bg=self.COLORS["surface"])
        search_frame.pack(fill=tk.X, pady=(0, 10))

        tk.Label(
            search_frame,
            text="Ø§Ù„Ø¨Ø­Ø«:",
            font=("Tajawal", 12),
            bg=self.COLORS["surface"]
        ).pack(side=tk.RIGHT, padx=(0, 10))

        search_entry = tk.Entry(
            search_frame,
            font=("Tajawal", 13),
            width=40
        )
        search_entry.pack(side=tk.RIGHT, fill=tk.X, expand=True)

        # Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
        list_frame = tk.Frame(teacher_frame, bg="white", relief=tk.GROOVE, bd=2)
        list_frame.pack(fill=tk.BOTH, expand=True)

        scrollbar = tk.Scrollbar(list_frame)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        teachers_listbox = tk.Listbox(
            list_frame,
            font=("Tajawal", 12),
            yscrollcommand=scrollbar.set,
            height=10,
            selectmode=tk.SINGLE
        )
        teachers_listbox.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        scrollbar.config(command=teachers_listbox.yview)

        def update_teachers_list():
            """ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©"""
            # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            category = selected_subject_category.get()

            if category == "specialized":
                # Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ®ØµØµÙŠØ© - ÙÙ‚Ø· Ø£Ø¹Ø¶Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³
                teacher_label.config(
                    text="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ Ù…Ù† Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³ (Ù…Ø§Ø¯Ø© ØªØ®ØµØµÙŠØ©):",
                    fg="#9C27B0"
                )
                load_faculty_teachers()
            else:
                # Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø© - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†
                teacher_label.config(
                    text="Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø±Ø³ (Ù…Ø§Ø¯Ø© Ø¹Ø§Ù…Ø©):",
                    fg="#FF9800"
                )
                load_all_teachers()

        def load_faculty_teachers():
            """ØªØ­Ù…ÙŠÙ„ Ø£Ø¹Ø¶Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³ ÙÙ‚Ø·"""
            teachers_listbox.delete(0, tk.END)
            teachers_map.clear()

            search_text = search_entry.get().strip()

            try:
                cursor = self.db_conn.cursor()

                if search_text:
                    cursor.execute("""
                        SELECT DISTINCT t.id, t.name, t.rank, t.workplace, t.category
                        FROM teachers t
                        INNER JOIN course_teacher_paths ctp ON t.id = ctp.teacher_id
                        WHERE ctp.course_name = ? AND LOWER(t.name) LIKE LOWER(?)
                        ORDER BY t.name
                    """, (course_name, f'%{search_text}%'))
                else:
                    cursor.execute("""
                        SELECT DISTINCT t.id, t.name, t.rank, t.workplace, t.category
                        FROM teachers t
                        INNER JOIN course_teacher_paths ctp ON t.id = ctp.teacher_id
                        WHERE ctp.course_name = ?
                        ORDER BY t.name
                    """, (course_name,))

                teachers = cursor.fetchall()

                if not teachers:
                    teachers_listbox.insert(tk.END, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù‡ÙŠØ¦Ø© ØªØ¯Ø±ÙŠØ³ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©")
                    return

                for i, (tid, name, rank, workplace, category) in enumerate(teachers):
                    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù„ÙƒÙ„ Ù…Ø¯Ø±Ø³
                    cursor.execute("""
                        SELECT course_name 
                        FROM course_teacher_paths 
                        WHERE teacher_id = ?
                    """, (tid,))

                    courses = [row[0] for row in cursor.fetchall()]

                    display_text = f"{rank} - {name}"
                    if courses:
                        display_text += f" (Ù…ØªØ®ØµØµ ÙÙŠ: {', '.join(courses)})"

                    teachers_listbox.insert(tk.END, display_text)
                    teachers_map[i] = tid

            except Exception as e:
                print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø¹Ø¶Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³: {e}")

        def load_all_teachers():
            """ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ† Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø©"""
            teachers_listbox.delete(0, tk.END)
            teachers_map.clear()

            search_text = search_entry.get().strip()

            try:
                if search_text:
                    cursor.execute("""
                        SELECT t.id, t.name, t.rank, t.workplace, t.category
                        FROM teachers t
                        WHERE LOWER(t.name) LIKE LOWER(?)
                        ORDER BY t.name
                        LIMIT 50
                    """, (f'%{search_text}%',))
                else:
                    cursor.execute("""
                        SELECT t.id, t.name, t.rank, t.workplace, t.category
                        FROM teachers t
                        ORDER BY t.name
                        LIMIT 100
                    """)

                teachers = cursor.fetchall()

                for i, (tid, name, rank, workplace, category) in enumerate(teachers):
                    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ù„ÙƒÙ„ Ù…Ø¯Ø±Ø³
                    cursor.execute("""
                        SELECT course_name 
                        FROM course_teacher_paths 
                        WHERE teacher_id = ?
                    """, (tid,))

                    courses = [row[0] for row in cursor.fetchall()]

                    display_text = f"{rank} - {name}"
                    if courses:
                        display_text += f" (Ù…ØªØ®ØµØµ ÙÙŠ: {', '.join(courses)})"

                    teachers_listbox.insert(tk.END, display_text)
                    teachers_map[i] = tid

            except Exception as e:
                print(f"Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†: {e}")

        # Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
        def on_search_change(*args):
            update_teachers_list()

        search_entry.bind('<KeyRelease>', on_search_change)

        # Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø±Ø³
        def on_teacher_select(event):
            selection = teachers_listbox.curselection()
            if selection:
                selected_teacher_id.set(teachers_map[selection[0]])

        teachers_listbox.bind('<<ListboxSelect>>', on_teacher_select)

        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
        update_teachers_list()

        # Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        btn_frame = tk.Frame(assign_window, bg=self.COLORS["surface"])
        btn_frame.pack(fill=tk.X, pady=20)

        def save():
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø§Ø¯Ø©
            if selected_subject_id.get() == 0:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ø¯Ø©")
                return

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
            if selected_teacher_id.get() == 0:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø±Ø³ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")
                return

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„Ù…Ø®ØªØ§Ø±
            cursor.execute("SELECT name, id_number FROM teachers WHERE id = ?", (selected_teacher_id.get(),))
            teacher_info = cursor.fetchone()
            if teacher_info:
                teacher_name = teacher_info[0]
                teacher_id_number = teacher_info[1]
            else:
                messagebox.showerror("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³")
                return

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ®ØµØµÙŠØ©
            if selected_subject_category.get() == "specialized":
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø¯Ø±Ø³ Ù…Ù† Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³
                cursor.execute("""
                    SELECT COUNT(*) FROM course_teacher_paths 
                    WHERE teacher_id = ? AND course_name = ?
                """, (selected_teacher_id.get(), course_name))

                if cursor.fetchone()[0] == 0:
                    messagebox.showerror(
                        "Ø®Ø·Ø£",
                        "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹ÙŠÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯Ø±Ø³ Ù„Ù…Ø§Ø¯Ø© ØªØ®ØµØµÙŠØ©!\n\n"
                        "Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØªØ®ØµØµÙŠØ© Ù…Ø­ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø£Ø¹Ø¶Ø§Ø¡ Ù‡ÙŠØ¦Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ³ ÙÙ‚Ø·."
                    )
                    return

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©
            selected_subject_type = subject_type_combo.get()

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª
            has_conflict, conflict_details = self._check_teacher_conflict(
                selected_teacher_id.get(),
                program_id,
                week_number,
                day_index,
                period_number,
                class_number
            )

            if has_conflict:
                # Ø¨Ù†Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ø±Ø¶
                conflict_msg = "âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¨Ø³Ø¨Ø¨ ÙˆØ¬ÙˆØ¯ ØªØ¹Ø§Ø±Ø¶Ø§Øª:\n\n"
                conflict_msg += f"Ø§Ù„Ù…Ø¯Ø±Ø³: {teacher_name} (Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©: {teacher_id_number})\n"
                conflict_msg += "Ù„Ø¯ÙŠÙ‡ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª:\n\n"

                for conflict in conflict_details:
                    conflict_msg += f"ğŸ”´ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: {conflict['program_number']}\n"
                    if 'class_number' in conflict and conflict['class_number'] > 1:
                        conflict_msg += f"   Ø§Ù„ÙØµÙ„: {conflict['class_number']}\n"
                    conflict_msg += f"   Ø§Ù„Ø¯ÙˆØ±Ø©: {conflict['course_name']}\n"
                    conflict_msg += f"   Ø§Ù„Ù…Ø§Ø¯Ø©: {conflict['subject_name']}\n"
                    conflict_msg += f"   Ø§Ù„ØªØ§Ø±ÙŠØ®: {conflict['date']}\n"
                    conflict_msg += f"   Ø§Ù„ÙˆÙ‚Øª: {days[day_index]} - Ø§Ù„Ø­ØµØ© {period_number}\n\n"

                conflict_msg += "âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠØªÙˆØ§Ø¬Ø¯ ÙÙŠ Ù…ÙƒØ§Ù†ÙŠÙ† Ù…Ø®ØªÙ„ÙÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª.\n"
                conflict_msg += "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø¯Ø±Ø³ Ø¢Ø®Ø± Ø£Ùˆ ØªØºÙŠÙŠØ± Ø§Ù„ÙˆÙ‚Øª."

                messagebox.showerror("ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„", conflict_msg)
                return

            try:
                # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                cursor.execute("PRAGMA table_info(program_schedule)")
                columns = [column[1] for column in cursor.fetchall()]

                if 'subject_type' not in columns:
                    cursor.execute("ALTER TABLE program_schedule ADD COLUMN subject_type TEXT DEFAULT 'Ù†Ø¸Ø±ÙŠ'")
                    self.db_conn.commit()

                if 'class_number' not in columns:
                    cursor.execute("ALTER TABLE program_schedule ADD COLUMN class_number INTEGER DEFAULT 1")
                    self.db_conn.commit()

                # Ø­ÙØ¸ Ø§Ù„ØªØ¹ÙŠÙŠÙ†
                cursor.execute("""
                    INSERT OR REPLACE INTO program_schedule
                    (program_id, week_number, day_of_week, period_number,
                     start_time, end_time, subject_id, teacher_id, 
                     subject_type, is_break, teacher_name, class_number)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 0, NULL, ?)
                """, (program_id, week_number, day_index, period_number,
                      time_info[0], time_info[1], selected_subject_id.get(),
                      selected_teacher_id.get(), selected_subject_type, class_number))

                self.db_conn.commit()

                messagebox.showinfo(
                    "Ù†Ø¬Ø§Ø­",
                    f"ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­\nÙ†ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¯Ø©: {selected_subject_type}"
                )

                assign_window.destroy()
                parent_window.destroy()
                self._manage_program_schedule(program_id, "", parent_window.master)

            except Exception as e:
                self.db_conn.rollback()
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

        btn_container = tk.Frame(btn_frame, bg=self.COLORS["surface"])
        btn_container.pack()

        tk.Button(
            btn_container,
            text="Ø­ÙØ¸",
            font=("Tajawal", 14, "bold"),
            bg=self.COLORS["success"],
            fg="white",
            bd=0,
            padx=40,
            pady=10,
            cursor="hand2",
            command=save
        ).pack(side=tk.LEFT, padx=10)

        tk.Button(
            btn_container,
            text="Ø¥Ù„ØºØ§Ø¡",
            font=("Tajawal", 14, "bold"),
            bg=self.COLORS["danger"],
            fg="white",
            bd=0,
            padx=40,
            pady=10,
            cursor="hand2",
            command=assign_window.destroy
        ).pack(side=tk.LEFT, padx=10)
