import sqlite3
import hashlib
import os, sys
import tkinter as tk
from tkinter import ttk, font as tkfont, messagebox
from datetime import datetime, timedelta
from tkcalendar import DateEntry

# ===== Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± =====
import hardware_verification
# ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© =====
# Ø§Ø³ØªÙŠØ±Ø§Ø¯Ø§Øª Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù„ØªØµØ¯ÙŠØ±
try:
    from docx import Document
    from docx.shared import Inches, Pt, RGBColor
    from docx.enum.text import WD_PARAGRAPH_ALIGNMENT
    from docx.enum.table import WD_TABLE_ALIGNMENT
    from docx.oxml import parse_xml
    from docx.oxml.ns import nsdecls
    DOCX_AVAILABLE = True
except ImportError:
    DOCX_AVAILABLE = False

try:
    import pandas as pd
    import openpyxl
    from openpyxl.styles import Alignment, Font, PatternFill, Border, Side
    EXCEL_AVAILABLE = True
except ImportError:
    EXCEL_AVAILABLE = False


def load_custom_font():
    """ØªØ­Ù…ÙŠÙ„ Ø®Ø· Tajawal"""
    try:
        import os
        import sys
        from tkinter import font as tkfont

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„Ø®Ø·
        if hasattr(sys, 'frozen'):
            # ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ
            font_path = os.path.join(sys._MEIPASS, 'Tajawal-Regular.ttf')
        else:
            # ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±
            font_path = 'Tajawal-Regular.ttf'

        if os.path.exists(font_path):
            # Windows
            if sys.platform.startswith('win'):
                import ctypes
                from ctypes import wintypes

                # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø· Ù…Ø¤Ù‚ØªØ§Ù‹
                FR_PRIVATE = 0x10
                FR_NOT_ENUM = 0x20

                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·
                ctypes.windll.gdi32.AddFontResourceExW(
                    font_path,
                    FR_PRIVATE | FR_NOT_ENUM,
                    0
                )
                print(f"ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·: {font_path}")

            return True
    except Exception as e:
        print(f"ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø·: {e}")
        return False


# Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
load_custom_font()


# ===== Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù‚Ø¨Ù„ class LoginSystem =====

def verify_license_activation():
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ - Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¨ÙŠÙ‡Ø§Øª"""
    import hardware_verification

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ±Ø®ÙŠØµ Ø¨ØµÙ…Øª
    if hardware_verification.check_license():
        return True
    else:
        # Ø§Ù„ØªØ±Ø®ÙŠØµ ØºÙŠØ± ØµØ§Ù„Ø­ - Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©
        show_activation_dialog()
        return False


def show_activation_dialog():
    """Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø­Ø³Ù†Ø©"""
    # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¬Ø°Ø± Ù…Ø®ÙÙŠØ©
    root = tk.Tk()
    root.withdraw()

    # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„
    dialog = tk.Toplevel(root)
    dialog.title("ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬")
    dialog.geometry("700x700")
    dialog.resizable(False, False)

    # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
    dialog.update_idletasks()
    x = (dialog.winfo_screenwidth() - 700) // 2
    y = (dialog.winfo_screenheight() - 700) // 2
    dialog.geometry(f"700x700+{x}+{y}")

    # Ø¬Ø¹Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
    dialog.attributes('-topmost', True)
    dialog.lift()
    dialog.focus_force()

    # Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø£ÙŠ Ø·Ø±ÙŠÙ‚Ø©
    def disable_close():
        messagebox.showwarning(
            "ØªØ­Ø°ÙŠØ±",
            "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¬Ø§ÙˆØ² Ø§Ù„ØªÙØ¹ÙŠÙ„!\nÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ ØªÙØ¹ÙŠÙ„ ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬"
        )

    dialog.protocol("WM_DELETE_WINDOW", disable_close)

    # Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    bg_color = "#f0f4f8"
    header_color = "#1a73e8"

    dialog.configure(bg=bg_color)

    # Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    header_frame = tk.Frame(dialog, bg=header_color, height=80)
    header_frame.pack(fill=tk.X)
    header_frame.pack_propagate(False)

    tk.Label(
        header_frame,
        text="ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨",
        font=("Tajawal", 22, "bold"),
        bg=header_color,
        fg="white"
    ).pack(expand=True)

    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„
    import hardware_verification
    info = hardware_verification.get_activation_info()

    # Ø¥Ø·Ø§Ø± Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
    if info['trial_available']:
        trial_frame = tk.Frame(dialog, bg="#e8f5e9", height=60)
        trial_frame.pack(fill=tk.X, pady=(10, 0))
        trial_frame.pack_propagate(False)

        trial_content = tk.Frame(trial_frame, bg="#e8f5e9")
        trial_content.pack(expand=True)

        tk.Label(
            trial_content,
            text="ğŸ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…Ø¬Ø§Ù†Ø§Ù‹ Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©",
            font=("Tajawal", 14, "bold"),
            bg="#e8f5e9",
            fg="#2e7d32"
        ).pack()

        def start_trial():
            if hardware_verification.start_trial():
                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©!\nÙ„Ø¯ÙŠÙƒ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„ØªØ¬Ø±Ø¨Ø©")
                dialog.quit()
                dialog.destroy()
                root.destroy()
            else:
                messagebox.showerror("Ø®Ø·Ø£", "ÙØ´Ù„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©")

        tk.Button(
            trial_content,
            text="Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©",
            command=start_trial,
            bg="#4caf50",
            fg="white",
            padx=20,
            pady=8,
            relief=tk.FLAT,
            font=("Tajawal", 12, "bold"),
            cursor="hand2"
        ).pack(pady=(5, 0))
    else:
        # Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
        warning_frame = tk.Frame(dialog, bg="#ffebee", height=60)
        warning_frame.pack(fill=tk.X, pady=(10, 0))
        warning_frame.pack_propagate(False)

        tk.Label(
            warning_frame,
            text="âš ï¸ Ø§Ù†ØªÙ‡Øª Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© - ÙŠØ¬Ø¨ Ø´Ø±Ø§Ø¡ Ø±Ø®ØµØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©",
            font=("Tajawal", 14, "bold"),
            bg="#ffebee",
            fg="#c62828"
        ).pack(expand=True)

    # Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²
    id_frame = tk.Frame(dialog, bg=bg_color)
    id_frame.pack(fill=tk.X, padx=20, pady=15)

    tk.Label(
        id_frame,
        text="Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²:",
        font=("Tajawal", 12, "bold"),
        bg=bg_color
    ).grid(row=0, column=0, sticky=tk.W, pady=5)

    machine_id_text = tk.Text(id_frame, height=1, width=35, font=("Courier", 14, "bold"))
    machine_id_text.insert(1.0, info['machine_id'])
    machine_id_text.config(state=tk.DISABLED, bg="#e8f0fe")
    machine_id_text.grid(row=1, column=0, pady=5)

    def copy_machine_id():
        dialog.clipboard_clear()
        dialog.clipboard_append(info['machine_id'])
        messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ù†Ø³Ø® Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø²", parent=dialog)

    tk.Button(
        id_frame,
        text="Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù",
        command=copy_machine_id,
        bg="#4CAF50",
        fg="white",
        padx=20,
        pady=8,
        relief=tk.FLAT,
        font=("Tajawal", 11, "bold"),
        cursor="hand2"
    ).grid(row=1, column=1, padx=10)

    # Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø®ÙŠØµ
    license_frame = tk.Frame(dialog, bg=bg_color)
    license_frame.pack(fill=tk.X, padx=20, pady=10)

    tk.Label(
        license_frame,
        text="Ù†ÙˆØ¹ Ø§Ù„ØªØ±Ø®ÙŠØµ:",
        font=("Tajawal", 12, "bold"),
        bg=bg_color
    ).pack(anchor=tk.W, pady=5)

    license_type = tk.StringVar(value="month")
    license_types = [
        ("Ø¯Ù‚ÙŠÙ‚Ø© (Ù„Ù„ØªØ¬Ø±Ø¨Ø©)", "minute"),
        ("Ø£Ø³Ø¨ÙˆØ¹", "week"),
        ("Ø´Ù‡Ø±", "month"),
        ("6 Ø£Ø´Ù‡Ø±", "6months"),
        ("Ø³Ù†Ø©", "year")
    ]

    for text, value in license_types:
        tk.Radiobutton(
            license_frame,
            text=text,
            variable=license_type,
            value=value,
            font=("Tajawal", 11),
            bg=bg_color
        ).pack(anchor=tk.W, padx=20)

    # Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„
    key_frame = tk.Frame(dialog, bg=bg_color)
    key_frame.pack(fill=tk.X, padx=20, pady=10)

    tk.Label(
        key_frame,
        text="Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„ (10 Ø£Ø±Ù‚Ø§Ù…):",
        font=("Tajawal", 12, "bold"),
        bg=bg_color
    ).pack(anchor=tk.W, pady=5)

    # Ø¥Ø·Ø§Ø± Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ø± Ø§Ù„Ù„ØµÙ‚
    entry_frame = tk.Frame(key_frame, bg=bg_color)
    entry_frame.pack(fill=tk.X)

    key_entry = tk.Entry(entry_frame, font=("Courier", 16, "bold"), justify=tk.CENTER)
    key_entry.pack(side=tk.LEFT, fill=tk.X, expand=True)
    key_entry.focus_set()

    # Ø²Ø± Ø§Ù„Ù„ØµÙ‚
    def paste_key():
        try:
            clipboard_text = dialog.clipboard_get().strip()
            numbers_only = ''.join(c for c in clipboard_text if c.isdigit())
            if len(numbers_only) > 10:
                numbers_only = numbers_only[:10]
            key_entry.delete(0, tk.END)
            key_entry.insert(0, numbers_only)
        except:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù„ØµÙ‚ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ¸Ø©", parent=dialog)

    tk.Button(
        entry_frame,
        text="Ù„ØµÙ‚ Ø§Ù„Ù…ÙØªØ§Ø­",
        command=paste_key,
        bg="#FF9800",
        fg="white",
        padx=20,
        pady=10,
        relief=tk.FLAT,
        font=("Tajawal", 11, "bold"),
        cursor="hand2"
    ).pack(side=tk.LEFT, padx=(10, 0))

    # ØªØ­Ø¯ÙŠØ¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ù„Ù€ 10 Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
    def validate_key_input(event):
        text = key_entry.get()
        numbers_only = ''.join(c for c in text if c.isdigit())
        if len(numbers_only) > 10:
            numbers_only = numbers_only[:10]
        key_entry.delete(0, tk.END)
        key_entry.insert(0, numbers_only)

    key_entry.bind('<KeyRelease>', validate_key_input)

    # Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù†Ø¬Ø§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„
    activation_success = [False]

    # Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    btn_frame = tk.Frame(dialog, bg=bg_color)
    btn_frame.pack(pady=20)

    def activate():
        key = key_entry.get().strip()

        if not key:
            messagebox.showerror("Ø®Ø·Ø£", "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„", parent=dialog)
            return

        if len(key) != 10 or not key.isdigit():
            messagebox.showerror("Ø®Ø·Ø£", "Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 10 Ø£Ø±Ù‚Ø§Ù…", parent=dialog)
            return

        success, message = hardware_verification.activate_software(key, license_type.get())

        if success:
            messagebox.showinfo("Ù†Ø¬Ø§Ø­", message, parent=dialog)
            activation_success[0] = True
            dialog.quit()
            dialog.destroy()
            root.destroy()
        else:
            messagebox.showerror("Ø®Ø·Ø£", message, parent=dialog)
            key_entry.delete(0, tk.END)
            key_entry.focus_set()

    def exit_program():
        if messagebox.askyesno(
                "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬",
                "Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŸ\n"
                "Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„",
                parent=dialog
        ):
            dialog.quit()
            dialog.destroy()
            root.destroy()
            import sys
            sys.exit(0)

    # Ø±Ø¨Ø· Enter Ø¨ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙØªØ§Ø­
    key_entry.bind('<Return>', lambda e: activate())

    tk.Button(
        btn_frame,
        text="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬",
        command=activate,
        bg="#1a73e8",
        fg="white",
        padx=40,
        pady=12,
        font=("Tajawal", 14, "bold"),
        relief=tk.FLAT,
        cursor="hand2"
    ).pack(side=tk.LEFT, padx=10)

    tk.Button(
        btn_frame,
        text="Ø®Ø±ÙˆØ¬",
        command=exit_program,
        bg="#dc3545",
        fg="white",
        padx=40,
        pady=12,
        font=("Tajawal", 14, "bold"),
        relief=tk.FLAT,
        cursor="hand2"
    ).pack(side=tk.LEFT, padx=10)

    # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
    contact_frame = tk.Frame(dialog, bg=bg_color)
    contact_frame.pack(side=tk.BOTTOM, pady=20)

    tk.Label(
        contact_frame,
        text="Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„",
        font=("Tajawal", 13, "bold"),
        bg=bg_color,
        fg="#1a73e8",
        justify=tk.CENTER
    ).pack()

    tk.Label(
        contact_frame,
        text="ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø·ÙˆØ±",
        font=("Tajawal", 14, "bold"),
        bg=bg_color,
        fg="#333",
        justify=tk.CENTER
    ).pack(pady=(5, 0))

    # Ø¨Ø¯Ø¡ Ø­Ù„Ù‚Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
    dialog.mainloop()

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„ØªÙØ¹ÙŠÙ„
    if not activation_success[0]:
        import sys
        sys.exit(0)

# ===== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¶Ø§ÙØ© =====

class LoginSystem:
    """Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""

    def __init__(self, root):
        self.root = root
        self.db_conn = self.connect_to_db()
        self.current_user = None
        self.create_users_table()
        self.create_permissions_table()
        self.check_admin_exists()
        self.setup_login_window()

    def connect_to_db(self):
        """Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        try:
            conn = sqlite3.connect("training_system.db")
            return conn
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", f"Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {str(e)}")
            exit(1)

    def create_users_table(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
        try:
            with self.db_conn:
                self.db_conn.execute("""
                    CREATE TABLE IF NOT EXISTS users (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        username TEXT UNIQUE,
                        password TEXT,
                        full_name TEXT,
                        created_date TEXT,
                        last_login TEXT,
                        is_active INTEGER DEFAULT 1
                    )
                """)
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", f"ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: {str(e)}")

    def create_permissions_table(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª"""
        try:
            with self.db_conn:
                self.db_conn.execute("""
                    CREATE TABLE IF NOT EXISTS user_permissions (
                        user_id INTEGER PRIMARY KEY,
                        can_add_teachers INTEGER DEFAULT 1,
                        can_edit_teachers INTEGER DEFAULT 1,
                        can_delete_teachers INTEGER DEFAULT 0,
                        can_add_courses INTEGER DEFAULT 1,
                        can_edit_courses INTEGER DEFAULT 1,
                        can_delete_courses INTEGER DEFAULT 0,
                        can_manage_users INTEGER DEFAULT 0,
                        is_admin INTEGER DEFAULT 0,
                        FOREIGN KEY (user_id) REFERENCES users(id)
                    )
                """)
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", f"ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: {str(e)}")

    def check_admin_exists(self):
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"""
        cursor = self.db_conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM users WHERE username='admin'")
        count = cursor.fetchone()[0]

        if count == 0:
            hashed_pwd = hashlib.sha256("admin123".encode()).hexdigest()
            try:
                with self.db_conn:
                    self.db_conn.execute("""
                        INSERT INTO users (username, password, full_name, created_date, is_active)
                        VALUES (?, ?, ?, ?, ?)
                    """, (
                        'admin',
                        hashed_pwd,
                        'Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
                        datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        1
                    ))
                    cursor.execute("SELECT id FROM users WHERE username='admin'")
                    admin_id = cursor.fetchone()[0]

                    self.db_conn.execute("""
                        INSERT INTO user_permissions (
                            user_id, can_add_teachers, can_edit_teachers, 
                            can_delete_teachers, can_add_courses, can_edit_courses,
                            can_delete_courses, can_manage_users, is_admin
                        ) VALUES (?, 1, 1, 1, 1, 1, 1, 1, 1)
                    """, (admin_id,))
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: {str(e)}")

    def setup_login_window(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ØªØµÙ…ÙŠÙ… Ø¹Ø±Ø¨ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ"""
        # ØªØ·Ø¨ÙŠÙ‚ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù†
        self.colors = {
            "primary": "#2C3E50",  # Ø£Ø²Ø±Ù‚ Ø±Ù…Ø§Ø¯ÙŠ Ø¯Ø§ÙƒÙ†
            "secondary": "#34495E",  # Ø±Ù…Ø§Ø¯ÙŠ Ø¯Ø§ÙƒÙ†
            "accent": "#3498DB",  # Ø£Ø²Ø±Ù‚ ÙØ§ØªØ­
            "background": "#ECF0F1",  # Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹
            "card": "#FFFFFF",  # Ø£Ø¨ÙŠØ¶
            "text": "#2C3E50",  # Ù†Øµ Ø¯Ø§ÙƒÙ†
            "success": "#27AE60",  # Ø£Ø®Ø¶Ø±
            "danger": "#E74C3C",  # Ø£Ø­Ù…Ø±
            "border": "#BDC3C7"  # Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ø­Ø¯ÙˆØ¯
        }

        self.root.title("Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨")
        self.root.geometry("1200x700")
        self.root.resizable(False, False)
        self.root.configure(bg=self.colors["background"])

        # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
        screen_width = self.root.winfo_screenwidth()
        screen_height = self.root.winfo_screenheight()
        x = (screen_width - 1200) // 2
        y = (screen_height - 700) // 2
        self.root.geometry(f"1200x700+{x}+{y}")

        # Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        main_container = tk.Frame(self.root, bg=self.colors["background"])
        main_container.pack(fill=tk.BOTH, expand=True)

        # Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù† - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        right_section = tk.Frame(main_container, bg=self.colors["primary"], width=600)
        right_section.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)
        right_section.pack_propagate(False)

        # Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù†
        right_content = tk.Frame(right_section, bg=self.colors["primary"])
        right_content.place(relx=0.5, rely=0.5, anchor=tk.CENTER)

        tk.Label(
            right_content,
            text="Ù…Ø¯ÙŠÙ†Ø© ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø¹Ø§Ù… \n Ø¨Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ©",
            font=("Tajawal", 36, "bold"),
            bg=self.colors["primary"],
            fg="white"
        ).pack(pady=(0, 20))

        tk.Label(
            right_content,
            text="Ø´Ø¹Ø¨Ø© Ø§Ù„Ø´Ø¤ÙˆÙ† Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©",
            font=("Tajawal", 24),
            bg=self.colors["primary"],
            fg="#ECF0F1"
        ).pack(pady=(0, 10))

        tk.Label(
            right_content,
            text="ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ ",
            font=("Tajawal", 20),
            bg=self.colors["primary"],
            fg="#BDC3C7"
        ).pack()

        # Ø®Ø· ÙØ§ØµÙ„
        separator = tk.Frame(right_content, bg="#34495E", height=2, width=200)
        separator.pack(pady=30)

        tk.Label(
            right_content,
            text="Ø§Ù„Ø§ØµØ¯Ø§Ø± Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ",
            font=("Tajawal", 16),
            bg=self.colors["primary"],
            fg="#ECF0F1",
            justify=tk.CENTER
        ).pack()

        # Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠØ³Ø± - Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        left_section = tk.Frame(main_container, bg="white", width=600)
        left_section.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        left_section.pack_propagate(False)

        # Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        login_form = tk.Frame(left_section, bg="white")
        login_form.place(relx=0.5, rely=0.5, anchor=tk.CENTER)

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        tk.Label(
            login_form,
            text="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
            font=("Tajawal", 28, "bold"),
            bg="white",
            fg=self.colors["primary"]
        ).pack(pady=(0, 40))

        # Ø¥Ø·Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        username_frame = tk.Frame(login_form, bg="white")
        username_frame.pack(fill=tk.X, pady=(0, 20))

        tk.Label(
            username_frame,
            text="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…",
            font=("Tajawal", 14),
            bg="white",
            fg=self.colors["text"],
            anchor=tk.E
        ).pack(fill=tk.X, pady=(0, 8))

        username_container = tk.Frame(username_frame, bg=self.colors["border"], height=45)
        username_container.pack(fill=tk.X)
        username_container.pack_propagate(False)

        self.username_entry = tk.Entry(
            username_container,
            font=("Tajawal", 14),
            bg="white",
            fg=self.colors["text"],
            bd=0,
            width=25,
            justify='right'
        )
        self.username_entry.pack(fill=tk.BOTH, padx=1, pady=1)
        self.username_entry.focus_set()

        # Ø¥Ø·Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        password_frame = tk.Frame(login_form, bg="white")
        password_frame.pack(fill=tk.X, pady=(0, 30))

        tk.Label(
            password_frame,
            text="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±",
            font=("Tajawal", 14),
            bg="white",
            fg=self.colors["text"],
            anchor=tk.E
        ).pack(fill=tk.X, pady=(0, 8))

        password_container = tk.Frame(password_frame, bg=self.colors["border"], height=45)
        password_container.pack(fill=tk.X)
        password_container.pack_propagate(False)

        self.password_entry = tk.Entry(
            password_container,
            font=("Tajawal", 14),
            bg="white",
            fg=self.colors["text"],
            show="â€¢",
            bd=0,
            width=25,
            justify='right'
        )
        self.password_entry.pack(fill=tk.BOTH, padx=1, pady=1)
        self.password_entry.bind("<Return>", lambda event: self.login())

        # Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        buttons_container = tk.Frame(login_form, bg="white")
        buttons_container.pack(fill=tk.X, pady=(0, 20))

        # Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        login_btn = tk.Button(
            buttons_container,
            text="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["accent"],
            fg="white",
            bd=0,
            cursor="hand2",
            command=self.login,
            height=2,
            width=12
        )
        login_btn.pack(side=tk.RIGHT, padx=(0, 10))

        # Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
        exit_btn = tk.Button(
            buttons_container,
            text="Ø®Ø±ÙˆØ¬",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["danger"],
            fg="white",
            bd=0,
            cursor="hand2",
            command=self.root.quit,
            height=2,
            width=12
        )
        exit_btn.pack(side=tk.LEFT)

        # ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        def on_enter_login(e):
            login_btn['bg'] = '#2980B9'

        def on_leave_login(e):
            login_btn['bg'] = self.colors["accent"]

        def on_enter_exit(e):
            exit_btn['bg'] = '#C0392B'

        def on_leave_exit(e):
            exit_btn['bg'] = self.colors["danger"]

        login_btn.bind("<Enter>", on_enter_login)
        login_btn.bind("<Leave>", on_leave_login)
        exit_btn.bind("<Enter>", on_enter_exit)
        exit_btn.bind("<Leave>", on_leave_exit)

        # Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
        self.status_label = tk.Label(
            login_form,
            text="",
            font=("Tajawal", 12),
            bg="white",
            fg=self.colors["danger"]
        )
        self.status_label.pack()

        # Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
        footer = tk.Frame(self.root, bg=self.colors["secondary"], height=40)
        footer.pack(side=tk.BOTTOM, fill=tk.X)
        footer.pack_propagate(False)

        tk.Label(
            footer,
            text="Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø´Ø¹Ø¨Ø© ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ù„Ø¹ÙˆÙ…Ø§Øª Ø¨Ù…Ø¯ÙŠÙ†Ø© ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø£Ù…Ù† Ø§Ù„Ø¹Ø§Ù… Ø¨Ø§Ù„Ù…Ø·Ù‚Ø© Ø§Ù„Ø´Ø±Ù‚ÙŠØ© Â© 2025",
            font=("Tajawal", 11),
            bg=self.colors["secondary"],
            fg="white"
        ).pack(expand=True)

    def login(self):
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""
        username = self.username_entry.get().strip()
        password = self.password_entry.get().strip()

        if not username or not password:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±")
            return

        hashed_pwd = hashlib.sha256(password.encode()).hexdigest()
        cursor = self.db_conn.cursor()
        cursor.execute("""
            SELECT u.id, u.username, u.full_name
            FROM users u
            WHERE u.username=? AND u.password=? AND u.is_active=1
        """, (username, hashed_pwd))
        user = cursor.fetchone()

        if user:
            cursor.execute("""
                SELECT 
                    can_add_teachers,
                    can_edit_teachers,
                    can_delete_teachers,
                    can_add_courses,
                    can_edit_courses,
                    can_delete_courses,
                    can_manage_users,
                    is_admin
                FROM user_permissions 
                WHERE user_id=?
            """, (user[0],))

            perm_row = cursor.fetchone()

            if not perm_row:
                is_admin = 1 if username == 'admin' else 0
                with self.db_conn:
                    self.db_conn.execute("""
                        INSERT INTO user_permissions (
                            user_id, can_add_teachers, can_edit_teachers, 
                            can_delete_teachers, can_add_courses, can_edit_courses,
                            can_delete_courses, can_manage_users, is_admin
                        ) VALUES (?, 1, 1, ?, 1, 1, ?, ?, ?)
                    """, (user[0], is_admin, is_admin, is_admin, is_admin))

                cursor.execute("""
                    SELECT 
                        can_add_teachers,
                        can_edit_teachers,
                        can_delete_teachers,
                        can_add_courses,
                        can_edit_courses,
                        can_delete_courses,
                        can_manage_users,
                        is_admin
                    FROM user_permissions 
                    WHERE user_id=?
                """, (user[0],))
                perm_row = cursor.fetchone()

            with self.db_conn:
                self.db_conn.execute("UPDATE users SET last_login=? WHERE id=?",
                                     (datetime.now().strftime("%Y-%m-%d %H:%M:%S"), user[0]))

            self.current_user = {
                "id": user[0],
                "username": user[1],
                "full_name": user[2],
                "permissions": {
                    "can_add_teachers": bool(perm_row[0]),
                    "can_edit_teachers": bool(perm_row[1]),
                    "can_delete_teachers": bool(perm_row[2]),
                    "can_add_courses": bool(perm_row[3]),
                    "can_edit_courses": bool(perm_row[4]),
                    "can_delete_courses": bool(perm_row[5]),
                    "can_manage_users": bool(perm_row[6]),
                    "is_admin": bool(perm_row[7])
                }
            }

            # Ø­ÙØ¸ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            current_root = self.root

            # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            main_window = ModernTrainingDesign(None, self.current_user, self.db_conn)

            # Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            current_root.withdraw()

            # Ø¨Ø¯Ø¡ Ø­Ù„Ù‚Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            main_window.mainloop()
        else:
            messagebox.showwarning("Ø®Ø·Ø£", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©")


class UserManagement:
    """Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""

    def __init__(self, root, conn, current_user, colors, fonts):
        self.root = root
        self.conn = conn
        self.current_user = current_user
        self.colors = colors
        self.fonts = fonts
        self.create_user_management_window()

    def create_user_management_window(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
        self.user_window = tk.Toplevel(self.root)
        self.user_window.title("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
        self.user_window.geometry("900x700")
        self.user_window.configure(bg=self.colors["light"])
        self.user_window.grab_set()
        self.user_window.resizable(True, True)

        x = (self.user_window.winfo_screenwidth() - 900) // 2
        y = (self.user_window.winfo_screenheight() - 700) // 2
        self.user_window.geometry(f"900x700+{x}+{y}")

        # Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        tk.Label(
            self.user_window,
            text="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
            font=self.fonts["large_title"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=10, width=900
        ).pack(fill=tk.X)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        button_frame = tk.Frame(self.user_window, bg=self.colors["light"], pady=10)
        button_frame.pack(fill=tk.X, padx=10)

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        buttons = [
            ("Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯", self.colors["success"], self.add_user),
            ("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯", self.colors["warning"], self.edit_user),
            ("ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", self.colors["secondary"], self.toggle_user_active),
            ("Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯", self.colors["danger"], self.delete_user),
            ("Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…", "#9C27B0", self.manage_user_permissions)
        ]

        for text, color, command in buttons:
            btn = tk.Button(
                button_frame,
                text=text,
                font=self.fonts["text_bold"],
                bg=color,
                fg="white",
                padx=10,
                pady=5,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=command
            )
            btn.pack(side=tk.RIGHT, padx=5)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
        table_frame = tk.Frame(self.user_window, bg=self.colors["light"], padx=10, pady=10)
        table_frame.pack(fill=tk.BOTH, expand=True)

        # Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ±
        tree_scroll = tk.Scrollbar(table_frame)
        tree_scroll.pack(side=tk.RIGHT, fill=tk.Y)

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        style = ttk.Style()
        style.configure("Modern.Treeview",
                        background=self.colors["light"],
                        foreground=self.colors["dark"],
                        rowheight=30,
                        fieldbackground=self.colors["light"],
                        font=self.fonts["text_bold"])
        style.configure("Modern.Treeview.Heading",
                        font=self.fonts["text_bold"],
                        background=self.colors["primary"],
                        foreground="white")
        style.map('Modern.Treeview', background=[('selected', self.colors["primary"])])

        self.users_tree = ttk.Treeview(
            table_frame,
            columns=("id", "username", "full_name", "created_date", "last_login", "status", "is_admin"),
            show="headings",
            yscrollcommand=tree_scroll.set,
            style="Modern.Treeview"
        )

        # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        self.users_tree.column("id", width=50, anchor=tk.CENTER)
        self.users_tree.column("username", width=120, anchor=tk.CENTER)
        self.users_tree.column("full_name", width=150, anchor=tk.CENTER)
        self.users_tree.column("created_date", width=120, anchor=tk.CENTER)
        self.users_tree.column("last_login", width=120, anchor=tk.CENTER)
        self.users_tree.column("status", width=80, anchor=tk.CENTER)
        self.users_tree.column("is_admin", width=80, anchor=tk.CENTER)

        # Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        self.users_tree.heading("id", text="Ø§Ù„Ø±Ù‚Ù…")
        self.users_tree.heading("username", text="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        self.users_tree.heading("full_name", text="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„")
        self.users_tree.heading("created_date", text="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡")
        self.users_tree.heading("last_login", text="Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„")
        self.users_tree.heading("status", text="Ø§Ù„Ø­Ø§Ù„Ø©")
        self.users_tree.heading("is_admin", text="Ù…Ø´Ø±Ù")

        self.users_tree.pack(fill=tk.BOTH, expand=True)
        tree_scroll.config(command=self.users_tree.yview)

        # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„ØµÙÙˆÙ
        self.users_tree.tag_configure("active", background="#e8f5e9")
        self.users_tree.tag_configure("inactive", background="#ffebee")
        self.users_tree.tag_configure("admin", background="#e1f5fe")

        self.load_users()

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        close_btn = tk.Button(
            self.user_window,
            text="Ø¥ØºÙ„Ø§Ù‚",
            font=self.fonts["text_bold"],
            bg=self.colors["dark"],
            fg="white",
            padx=15,
            pady=5,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=self.user_window.destroy
        )
        close_btn.pack(pady=10)

    def load_users(self):
        """ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†"""
        for item in self.users_tree.get_children():
            self.users_tree.delete(item)

        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT u.id, u.username, u.full_name, u.created_date, u.last_login, u.is_active,
                   COALESCE(p.is_admin, 0) as is_admin
            FROM users u
            LEFT JOIN user_permissions p ON u.id = p.user_id
        """)
        users = cursor.fetchall()

        for user in users:
            user_id, username, full_name, created_date, last_login, is_active, is_admin = user
            status = "Ù†Ø´Ø·" if is_active else "Ù…Ø¹Ø·Ù„"
            admin_status = "Ù†Ø¹Ù…" if is_admin else "Ù„Ø§"
            if not last_login:
                last_login = "Ù„Ù… ÙŠØ³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¹Ø¯"

            item_id = self.users_tree.insert("", tk.END, values=(
                user_id, username, full_name, created_date, last_login, status, admin_status))

            if not is_active:
                self.users_tree.item(item_id, tags=("inactive",))
            elif is_admin:
                self.users_tree.item(item_id, tags=("admin",))
            else:
                self.users_tree.item(item_id, tags=("active",))

    def add_user(self):
        """Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯"""
        add_window = tk.Toplevel(self.user_window)
        add_window.title("Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯")
        add_window.geometry("400x430")
        add_window.configure(bg=self.colors["light"])
        add_window.transient(self.user_window)
        add_window.grab_set()

        x = (add_window.winfo_screenwidth() - 400) // 2
        y = (add_window.winfo_screenheight() - 430) // 2
        add_window.geometry(f"400x430+{x}+{y}")

        tk.Label(
            add_window,
            text="Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯",
            font=self.fonts["title"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=10, width=400
        ).pack(fill=tk.X)

        form_frame = tk.Frame(add_window, bg=self.colors["light"], padx=20, pady=20)
        form_frame.pack(fill=tk.BOTH)

        # Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        tk.Label(form_frame, text="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", font=self.fonts["text_bold"],
                 bg=self.colors["light"], anchor=tk.E).grid(row=0, column=1, padx=5, pady=8, sticky=tk.E)
        username_entry = tk.Entry(form_frame, font=self.fonts["text"], width=25)
        username_entry.grid(row=0, column=0, padx=5, pady=8, sticky=tk.W)

        tk.Label(form_frame, text="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:", font=self.fonts["text_bold"],
                 bg=self.colors["light"], anchor=tk.E).grid(row=1, column=1, padx=5, pady=8, sticky=tk.E)
        fullname_entry = tk.Entry(form_frame, font=self.fonts["text"], width=25)
        fullname_entry.grid(row=1, column=0, padx=5, pady=8, sticky=tk.W)

        tk.Label(form_frame, text="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:", font=self.fonts["text_bold"],
                 bg=self.colors["light"], anchor=tk.E).grid(row=2, column=1, padx=5, pady=8, sticky=tk.E)
        password_entry = tk.Entry(form_frame, font=self.fonts["text"], width=25, show="*")
        password_entry.grid(row=2, column=0, padx=5, pady=8, sticky=tk.W)

        tk.Label(form_frame, text="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:", font=self.fonts["text_bold"],
                 bg=self.colors["light"], anchor=tk.E).grid(row=3, column=1, padx=5, pady=8, sticky=tk.E)
        confirm_entry = tk.Entry(form_frame, font=self.fonts["text"], width=25, show="*")
        confirm_entry.grid(row=3, column=0, padx=5, pady=8, sticky=tk.W)

        is_admin_var = tk.IntVar(master=add_window, value=0)
        admin_check = tk.Checkbutton(
            form_frame,
            text="Ø¬Ø¹Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±ÙÙ‹Ø§",
            variable=is_admin_var,
            font=self.fonts["text"],
            bg=self.colors["light"]
        )
        admin_check.grid(row=4, column=0, columnspan=2, padx=5, pady=8, sticky=tk.W)

        button_frame = tk.Frame(add_window, bg=self.colors["light"], pady=10)
        button_frame.pack(fill=tk.X)

        def save_user():
            username = username_entry.get().strip()
            fullname = fullname_entry.get().strip()
            password = password_entry.get().strip()
            confirm = confirm_entry.get().strip()
            is_admin = is_admin_var.get()

            if not all([username, fullname, password, confirm]):
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„")
                return
            if password != confirm:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©")
                return

            cursor = self.conn.cursor()
            cursor.execute("SELECT COUNT(*) FROM users WHERE username=?", (username,))
            count = cursor.fetchone()[0]
            if count > 0:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„")
                return

            hashed_pwd = hashlib.sha256(password.encode()).hexdigest()
            try:
                with self.conn:
                    self.conn.execute("""
                        INSERT INTO users (username, password, full_name, created_date, is_active)
                        VALUES (?, ?, ?, ?, ?)
                    """, (
                        username,
                        hashed_pwd,
                        fullname,
                        datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        1
                    ))

                    cursor.execute("SELECT id FROM users WHERE username=?", (username,))
                    user_id = cursor.fetchone()[0]

                    if is_admin:
                        self.conn.execute("""
                            INSERT INTO user_permissions (
                                user_id, can_add_teachers, can_edit_teachers, 
                                can_delete_teachers, can_add_courses, can_edit_courses,
                                can_delete_courses, can_manage_users, is_admin
                            ) VALUES (?, 1, 1, 1, 1, 1, 1, 1, 1)
                        """, (user_id,))
                    else:
                        self.conn.execute("""
                            INSERT INTO user_permissions (
                                user_id, can_add_teachers, can_edit_teachers, 
                                can_delete_teachers, can_add_courses, can_edit_courses,
                                can_delete_courses, can_manage_users, is_admin
                            ) VALUES (?, 1, 1, 0, 1, 1, 0, 0, 0)
                        """, (user_id,))

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­")
                add_window.destroy()
                self.load_users()
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {str(e)}")

        save_btn = tk.Button(button_frame, text="Ø­ÙØ¸", font=self.fonts["text_bold"],
                             bg=self.colors["success"], fg="white",
                             padx=15, pady=5, bd=0, relief=tk.FLAT, cursor="hand2", command=save_user)
        save_btn.pack(side=tk.LEFT, padx=10)

        cancel_btn = tk.Button(button_frame, text="Ø¥Ù„ØºØ§Ø¡", font=self.fonts["text_bold"],
                               bg=self.colors["danger"], fg="white",
                               padx=15, pady=5, bd=0, relief=tk.FLAT, cursor="hand2",
                               command=add_window.destroy)
        cancel_btn.pack(side=tk.RIGHT, padx=10)

    def edit_user(self):
        """ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        selected_item = self.users_tree.selection()
        if not selected_item:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")
            return

        values = self.users_tree.item(selected_item, "values")
        user_id = values[0]

        cursor = self.conn.cursor()
        cursor.execute("SELECT * FROM users WHERE id=?", (user_id,))
        user = cursor.fetchone()

        if not user:
            messagebox.showerror("Ø®Ø·Ø£", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
            return

        cursor.execute("SELECT * FROM user_permissions WHERE user_id=?", (user_id,))
        permissions = cursor.fetchone()
        is_admin = 0
        if permissions:
            is_admin = permissions[8]  # is_admin index

        edit_window = tk.Toplevel(self.user_window)
        edit_window.title("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…")
        edit_window.geometry("400x430")
        edit_window.configure(bg=self.colors["light"])
        edit_window.transient(self.user_window)
        edit_window.grab_set()

        x = (edit_window.winfo_screenwidth() - 400) // 2
        y = (edit_window.winfo_screenheight() - 430) // 2
        edit_window.geometry(f"400x430+{x}+{y}")

        tk.Label(
            edit_window,
            text=f"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {user[1]}",
            font=self.fonts["title"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=10, width=400
        ).pack(fill=tk.X)

        form_frame = tk.Frame(edit_window, bg=self.colors["light"], padx=20, pady=20)
        form_frame.pack(fill=tk.BOTH)

        tk.Label(form_frame, text="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:", font=self.fonts["text_bold"],
                 bg=self.colors["light"], anchor=tk.E).grid(row=0, column=1, padx=5, pady=8, sticky=tk.E)
        username_entry = tk.Entry(form_frame, font=self.fonts["text"], width=25)
        username_entry.insert(0, user[1])
        username_entry.grid(row=0, column=0, padx=5, pady=8, sticky=tk.W)

        tk.Label(form_frame, text="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:", font=self.fonts["text_bold"],
                 bg=self.colors["light"], anchor=tk.E).grid(row=1, column=1, padx=5, pady=8, sticky=tk.E)
        fullname_entry = tk.Entry(form_frame, font=self.fonts["text"], width=25)
        fullname_entry.insert(0, user[3])
        fullname_entry.grid(row=1, column=0, padx=5, pady=8, sticky=tk.W)

        tk.Label(form_frame, text="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:", font=self.fonts["text_bold"],
                 bg=self.colors["light"], anchor=tk.E).grid(row=2, column=1, padx=5, pady=8, sticky=tk.E)
        password_entry = tk.Entry(form_frame, font=self.fonts["text"], width=25, show="*")
        password_entry.grid(row=2, column=0, padx=5, pady=8, sticky=tk.W)

        tk.Label(form_frame, text="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:", font=self.fonts["text_bold"],
                 bg=self.colors["light"], anchor=tk.E).grid(row=3, column=1, padx=5, pady=8, sticky=tk.E)
        confirm_entry = tk.Entry(form_frame, font=self.fonts["text"], width=25, show="*")
        confirm_entry.grid(row=3, column=0, padx=5, pady=8, sticky=tk.W)

        is_admin_var = tk.IntVar(master=edit_window, value=is_admin)
        admin_check = tk.Checkbutton(
            form_frame,
            text="Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±Ù",
            variable=is_admin_var,
            font=self.fonts["text"],
            bg=self.colors["light"]
        )
        admin_check.grid(row=4, column=0, columnspan=2, padx=5, pady=8, sticky=tk.W)

        button_frame = tk.Frame(edit_window, bg=self.colors["light"], pady=10)
        button_frame.pack(fill=tk.X)

        def save_changes():
            username = username_entry.get().strip()
            fullname = fullname_entry.get().strip()
            password = password_entry.get().strip()
            confirm = confirm_entry.get().strip()
            is_admin = is_admin_var.get()

            if not all([username, fullname]):
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©")
                return

            if password:
                if password != confirm:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©")
                    return

            try:
                with self.conn:
                    if password:
                        hashed_pwd = hashlib.sha256(password.encode()).hexdigest()
                        self.conn.execute("UPDATE users SET username=?, full_name=?, password=? WHERE id=?",
                                          (username, fullname, hashed_pwd, user[0]))
                    else:
                        self.conn.execute("UPDATE users SET username=?, full_name=? WHERE id=?",
                                          (username, fullname, user[0]))

                    cursor = self.conn.cursor()
                    cursor.execute("SELECT COUNT(*) FROM user_permissions WHERE user_id=?", (user[0],))
                    has_permissions = cursor.fetchone()[0] > 0

                    if has_permissions:
                        self.conn.execute("UPDATE user_permissions SET is_admin=? WHERE user_id=?",
                                          (is_admin, user[0]))
                    else:
                        if is_admin:
                            self.conn.execute("""
                                INSERT INTO user_permissions (
                                    user_id, can_add_teachers, can_edit_teachers, 
                                    can_delete_teachers, can_add_courses, can_edit_courses,
                                    can_delete_courses, can_manage_users, is_admin
                                ) VALUES (?, 1, 1, 1, 1, 1, 1, 1, 1)
                            """, (user[0],))
                        else:
                            self.conn.execute("""
                                INSERT INTO user_permissions (
                                    user_id, can_add_teachers, can_edit_teachers, 
                                    can_delete_teachers, can_add_courses, can_edit_courses,
                                    can_delete_courses, can_manage_users, is_admin
                                ) VALUES (?, 1, 1, 0, 1, 1, 0, 0, 0)
                            """, (user[0],))

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­")
                edit_window.destroy()
                self.load_users()
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {str(e)}")

        save_btn = tk.Button(button_frame, text="Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª", font=self.fonts["text_bold"],
                             bg=self.colors["warning"], fg="white",
                             padx=15, pady=5, bd=0, relief=tk.FLAT, cursor="hand2", command=save_changes)
        save_btn.pack(side=tk.LEFT, padx=10)

        cancel_btn = tk.Button(button_frame, text="Ø¥Ù„ØºØ§Ø¡", font=self.fonts["text_bold"],
                               bg=self.colors["danger"], fg="white",
                               padx=15, pady=5, bd=0, relief=tk.FLAT, cursor="hand2",
                               command=edit_window.destroy)
        cancel_btn.pack(side=tk.RIGHT, padx=10)

    def toggle_user_active(self):
        """ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        selected_item = self.users_tree.selection()
        if not selected_item:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")
            return

        values = self.users_tree.item(selected_item, "values")
        user_id = values[0]
        username = values[1]
        status_text = values[5]

        if username == self.current_user["username"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ")
            return

        new_status = 0 if status_text == "Ù†Ø´Ø·" else 1
        status_msg = "ØªÙØ¹ÙŠÙ„" if new_status == 1 else "ØªØ¹Ø·ÙŠÙ„"

        if not messagebox.askyesno("ØªØ£ÙƒÙŠØ¯", f"Ù‡Ù„ ØªØ±ÙŠØ¯ {status_msg} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {username}ØŸ"):
            return

        try:
            with self.conn:
                self.conn.execute("UPDATE users SET is_active=? WHERE id=?", (new_status, user_id))
            messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… {status_msg} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­")
            self.load_users()
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£: {str(e)}")

    def delete_user(self):
        """Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        selected_item = self.users_tree.selection()
        if not selected_item:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")
            return

        values = self.users_tree.item(selected_item, "values")
        user_id = values[0]
        username = values[1]

        if username == self.current_user["username"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ")
            return

        if not messagebox.askyesno("ØªØ£ÙƒÙŠØ¯", f"Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… {username}ØŸ\nÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!"):
            return

        try:
            with self.conn:
                self.conn.execute("DELETE FROM user_permissions WHERE user_id=?", (user_id,))
                self.conn.execute("DELETE FROM users WHERE id=?", (user_id,))
            messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­")
            self.load_users()
        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {str(e)}")

    def manage_user_permissions(self):
        """Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        selected_item = self.users_tree.selection()
        if not selected_item:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©")
            return

        values = self.users_tree.item(selected_item, "values")
        user_id = values[0]
        username = values[1]

        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT 
                can_add_teachers,
                can_edit_teachers,
                can_delete_teachers,
                can_add_courses,
                can_edit_courses,
                can_delete_courses,
                can_manage_users,
                is_admin
            FROM user_permissions 
            WHERE user_id=?
        """, (user_id,))

        permissions = cursor.fetchone()

        if not permissions:
            permissions = (1, 1, 0, 1, 1, 0, 0, 0)

        perm_window = tk.Toplevel(self.user_window)
        perm_window.title(f"Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {username}")
        perm_window.geometry("500x600")
        perm_window.configure(bg=self.colors["light"])
        perm_window.transient(self.user_window)
        perm_window.grab_set()

        x = (perm_window.winfo_screenwidth() - 500) // 2
        y = (perm_window.winfo_screenheight() - 600) // 2
        perm_window.geometry(f"500x600+{x}+{y}")

        tk.Label(
            perm_window,
            text=f"ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {username}",
            font=self.fonts["title"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=10
        ).pack(fill=tk.X)

        perm_frame = tk.Frame(perm_window, bg=self.colors["light"], padx=20, pady=20)
        perm_frame.pack(fill=tk.BOTH, expand=True)

        # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        is_admin_var = tk.IntVar(master=perm_window, value=permissions[7])
        can_add_teachers_var = tk.IntVar(master=perm_window, value=permissions[0])
        can_edit_teachers_var = tk.IntVar(master=perm_window, value=permissions[1])
        can_delete_teachers_var = tk.IntVar(master=perm_window, value=permissions[2])
        can_add_courses_var = tk.IntVar(master=perm_window, value=permissions[3])
        can_edit_courses_var = tk.IntVar(master=perm_window, value=permissions[4])
        can_delete_courses_var = tk.IntVar(master=perm_window, value=permissions[5])
        can_manage_users_var = tk.IntVar(master=perm_window, value=permissions[6])

        def update_permissions():
            is_admin = is_admin_var.get()
            if is_admin:
                for var in [can_add_teachers_var, can_edit_teachers_var, can_delete_teachers_var,
                            can_add_courses_var, can_edit_courses_var, can_delete_courses_var,
                            can_manage_users_var]:
                    var.set(1)

                for checkbox in permission_checkboxes:
                    checkbox.config(state=tk.DISABLED)
            else:
                for checkbox in permission_checkboxes:
                    checkbox.config(state=tk.NORMAL)

        admin_title = tk.Label(perm_frame, text="ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ø§Ù…Ø©:", font=self.fonts["text_bold"],
                               bg=self.colors["light"])
        admin_title.grid(row=0, column=0, sticky=tk.W, pady=(0, 10))

        admin_check = tk.Checkbutton(
            perm_frame,
            text="Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø´Ø±Ù (ÙŠÙ…Ù„Ùƒ ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)",
            variable=is_admin_var,
            font=self.fonts["text_bold"],
            bg=self.colors["light"],
            command=update_permissions
        )
        admin_check.grid(row=1, column=0, sticky=tk.W, pady=5)

        specific_title = tk.Label(perm_frame, text="ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø­Ø¯Ø¯Ø©:", font=self.fonts["text_bold"],
                                  bg=self.colors["light"])
        specific_title.grid(row=2, column=0, sticky=tk.W, pady=(20, 10))

        permission_options = [
            (can_add_teachers_var, "Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø±Ø³ÙŠÙ† Ø¬Ø¯Ø¯"),
            (can_edit_teachers_var, "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†"),
            (can_delete_teachers_var, "Ø­Ø°Ù Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†"),
            (can_add_courses_var, "Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©"),
            (can_edit_courses_var, "ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø§Øª"),
            (can_delete_courses_var, "Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ±Ø§Øª"),
            (can_manage_users_var, "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†")
        ]

        permission_checkboxes = []
        for i, (var, text) in enumerate(permission_options):
            checkbox = tk.Checkbutton(
                perm_frame,
                text=text,
                variable=var,
                font=self.fonts["text"],
                bg=self.colors["light"]
            )
            checkbox.grid(row=i + 3, column=0, sticky=tk.W, pady=5)
            permission_checkboxes.append(checkbox)

        update_permissions()

        button_frame = tk.Frame(perm_window, bg=self.colors["light"], pady=10)
        button_frame.pack(fill=tk.X, padx=20)

        def save_permissions():
            try:
                with self.conn:
                    self.conn.execute("""
                        UPDATE user_permissions SET
                            is_admin=?,
                            can_add_teachers=?,
                            can_edit_teachers=?,
                            can_delete_teachers=?,
                            can_add_courses=?,
                            can_edit_courses=?,
                            can_delete_courses=?,
                            can_manage_users=?
                        WHERE user_id=?
                    """, (
                        is_admin_var.get(),
                        can_add_teachers_var.get(),
                        can_edit_teachers_var.get(),
                        can_delete_teachers_var.get(),
                        can_add_courses_var.get(),
                        can_edit_courses_var.get(),
                        can_delete_courses_var.get(),
                        can_manage_users_var.get(),
                        user_id
                    ))

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­")
                perm_window.destroy()
                self.load_users()
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: {str(e)}")

        save_btn = tk.Button(button_frame, text="Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª", font=self.fonts["text_bold"],
                             bg=self.colors["success"], fg="white", padx=15, pady=5, bd=0,
                             relief=tk.FLAT, cursor="hand2", command=save_permissions)
        save_btn.pack(side=tk.LEFT, padx=10)

        cancel_btn = tk.Button(button_frame, text="Ø¥Ù„ØºØ§Ø¡", font=self.fonts["text_bold"],
                               bg=self.colors["danger"], fg="white", padx=15, pady=5, bd=0,
                               relief=tk.FLAT, cursor="hand2", command=perm_window.destroy)
        cancel_btn.pack(side=tk.RIGHT, padx=10)


class ModernTrainingDesign(tk.Tk):
    """ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ - Ù‚Ø§Ù„Ø¨ ÙØ§Ø±Øº"""

    APP_NAME = "Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨"
    BASE_PATH = getattr(sys, "_MEIPASS", os.path.dirname(os.path.abspath(__file__)))
    FONT_PATH = os.path.join(BASE_PATH, "assets", "fonts", "Tajawal-Regular.ttf")

    # Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù„ÙˆØ§Ù†
    COLORS = {
        "primary": "#1a73e8",
        "secondary": "#4285f4",
        "success": "#34a853",
        "danger": "#ea4335",
        "warning": "#fbbc05",
        "light": "#f0f4f8",
        "dark": "#202124",
        "surface": "#FFFFFF",
        "background": "#f0f4f8",
        "card": "#FFFFFF",
        "on_surface": "#202124",
        "border": "#E5E7EB",
    }

    # â€” Ø­Ø¯Ù‘Ø«/Ø£Ø¶Ù Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ FONTS â€”
    FONTS = {
        "large_title": ("Tajawal", 24, "bold"),
        "title": ("Tajawal", 18, "bold"),
        "subtitle": ("Tajawal", 16, "bold"),
        "text": ("Tajawal", 12),
        "text_bold": ("Tajawal", 12, "bold"),
        "small": ("Tajawal", 10),
        "nav": ("Tajawal", 20, "bold"),  # â† Ø®Ø° Ù…Ù‚Ø§Ø³ Ø£ÙƒØ¨Ø± Ù„Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
        "body": ("Tajawal", 14),
        "large": ("Tajawal", 16, "bold"),
    }

    def __init__(self, root=None, current_user=None, db_conn=None):
        super().__init__()

        self.title("Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ - Ù‚Ø³Ù… ØªØµÙ…ÙŠÙ… ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬")
        self.current_user = current_user
        self.db_conn = db_conn

        # Ø§Ù„ØªÙƒÙŠÙ Ù…Ø¹ Ø­Ø¬Ù… Ø§Ù„Ø´Ø§Ø´Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        screen_width = self.winfo_screenwidth()
        screen_height = self.winfo_screenheight()

        app_width = min(1400, int(screen_width * 0.90))
        app_height = min(800, int(screen_height * 0.90))

        x = (screen_width - app_width) // 2
        y = (screen_height - app_height) // 2

        self.geometry(f"{app_width}x{app_height}+{x}+{y}")
        self.minsize(800, 600)
        self.configure(bg=self.COLORS["background"])

        self.screen_width = screen_width
        self.screen_height = screen_height
        self.app_width = app_width
        self.app_height = app_height

        self._load_font()
        self._setup_styles()

        self.current_page = "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"
        self._is_closing = False  # Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
        self._create_database_tables()

        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙØ©
        self._ensure_archive_columns()

        # Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        self._create_header()
        self._create_tab_control()
        self._create_footer()

        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
        self.protocol("WM_DELETE_WINDOW", self._on_closing)

    def _ensure_archive_columns(self):
        """Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙØ© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        try:
            cursor = self.db_conn.cursor()

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
            cursor.execute("PRAGMA table_info(training_programs)")
            columns = [column[1] for column in cursor.fetchall()]

            # Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ is_archived Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if 'is_archived' not in columns:
                cursor.execute("ALTER TABLE training_programs ADD COLUMN is_archived INTEGER DEFAULT 0")
                print("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ is_archived")

            # Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ archived_date Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            if 'archived_date' not in columns:
                cursor.execute("ALTER TABLE training_programs ADD COLUMN archived_date TEXT")
                print("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ archived_date")

            self.db_conn.commit()

        except Exception as e:
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø±Ø´ÙØ©: {e}")

    def _on_closing(self):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¨Ø´ÙƒÙ„ Ù†Ø¸ÙŠÙ"""
        if self._is_closing:
            return

        self._is_closing = True

        try:
            # Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©
            for widget in self.winfo_children():
                try:
                    widget.destroy()
                except:
                    pass

            # Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if hasattr(self, 'db_conn') and self.db_conn:
                try:
                    self.db_conn.close()
                except:
                    pass

            # Ø¥ÙŠÙ‚Ø§Ù mainloop
            self.quit()

        except:
            pass
        finally:
            try:
                self.destroy()
            except:
                pass

            # Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
            import sys
            sys.exit(0)

    def _load_font(self):
        """
        ØªØ­Ù…ÙŠÙ„ Ø®Ø· Tajawal Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© ØªØ¹Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¬Ù…ÙŠØ¯ Ø¨Ù€Â PyInstaller.
        â€¢ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø· Ù…Ø³Ø¬Ù‘ÙÙ„Ø§Ù‹ (load_custom_font Ø£Ø¶Ø§ÙÙ‡ Ø¨Ù†Ø¬Ø§Ø­) Ù†ÙƒØªÙÙŠ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù†Ù…Ø· Ø§Ø³Ù…Ù‡ Tajawal.
        â€¢ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø³Ø¬Ù‘ÙÙ„Ø§Ù‹ Ù†Ø­Ø§ÙˆÙ„ Ø¥Ù†Ø´Ø§Ø¡Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…Ù„Ù .ttf.
        """
        import tkinter.font as tkfont
        font_name = "Tajawal"

        try:
            # ØªØ±Ø¬Ø¹ ÙƒØ§Ø¦Ù† Font Ù„Ùˆ ÙƒØ§Ù† Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯
            tkfont.nametofont(font_name)
        except tk.TclError:
            try:
                # â¶ Ø¬Ø±Ù‘Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø· Ù…Ù† Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø©
                if os.path.isfile(self.FONT_PATH):
                    tkfont.Font(name=font_name, file=self.FONT_PATH, size=12)
                else:
                    # â· fallback: Ø£Ù†Ø´Ø¦ Ø®Ø·Ø§Ù‹ Ø¨Ù†ÙØ³ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                    tkfont.Font(name=font_name, family="Tajawal", size=12)
            except Exception as e:
                print(f"âš ï¸ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø®Ø· Tajawal: {e}")

    def _setup_styles(self):
        """ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø±Ù…Ø§Ø¯ÙŠØ© Ø¯Ø§ÙƒÙ†Ø©ØŒ ØªÙƒØ¨ÙŠØ± Ø¨Ø³ÙŠØ·ØŒ Ø®Ø· Ø£Ø³ÙˆØ¯"""
        try:
            style = ttk.Style(self)

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø«ÙŠÙ…
            available_themes = style.theme_names()
            if "clam" in available_themes:
                style.theme_use("clam")
            else:
                # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø«ÙŠÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† clam Ù…ØªÙˆÙØ±Ø§Ù‹
                style.theme_use("default")

            # Ø£Ù„ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ø©
            base_gray = "#8c8c8c"  # Ø±Ù…Ø§Ø¯ÙŠ Ø£ØºÙ…Ù‚ Ù„Ù„Ø²Ø± ØºÙŠØ± Ø§Ù„Ù…Ø­Ø¯ÙÙ‘Ø¯
            hover_gray = "#a8a8a8"  # Ø±Ù…Ø§Ø¯ÙŠ Ù…ØªÙˆØ³Ø· Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ±
            selected_color = "#3B82F6"  # Ø£Ø²Ø±Ù‚ Ù„Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            txt_color = "black"
            selected_txt = "black"  # Ù†Øµ Ø£Ø³ÙˆØ¯ Ù„Ù„ØªØ¨ÙˆÙŠØ¨Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            notebook_bg = "#e8e8e8"  # Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ù„Ù„Ø®Ù„ÙÙŠØ©

            # Notebook Ø¨Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© ÙØ§ØªØ­Ø©
            style.configure("Bold.TNotebook",
                            background=notebook_bg,  # ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¥Ù„Ù‰ Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­
                            borderwidth=0,
                            relief="flat",
                            tabmargins=[2, 5, 2, 0])  # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª

            # ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø£ÙƒØ¨Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹: Ø®Ø· Ø£ÙƒØ¨Ø± ÙˆØ¨Ø§Ø¯ÙŠÙ†Øº Ø£ÙƒØ«Ø±
            style.configure("Bold.TNotebook.Tab",
                            font=self.FONTS["subtitle"],  # â† Ø­Ø¬Ù… 16 Ø¹Ø±ÙŠØ¶
                            padding=[16, 8],  # â† Ø¹Ø±Ø¶ ÙˆØ§Ø±ØªÙØ§Ø¹ Ø£ÙƒØ¨Ø±
                            borderwidth=0,
                            relief="flat",
                            background=base_gray,
                            foreground=txt_color)

            # ØªØºÙŠÙ‘Ø± Ø§Ù„Ù„ÙˆÙ† Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£Ùˆ Ø§Ù„Ù…Ø±ÙˆØ±
            style.map("Bold.TNotebook.Tab",
                      background=[("selected", selected_color),
                                  ("active", hover_gray)],
                      foreground=[("selected", selected_txt),
                                  ("active", txt_color)])

            # Ø¥Ø²Ø§Ù„Ø© Ø®Ø· Ø§Ù„ØªØ±ÙƒÙŠØ² Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§
            try:
                style.layout("Bold.TNotebook.Tab",
                             [('Notebook.padding', {'side': 'top', 'sticky': 'nswe', 'children': [
                                 ('Notebook.label', {'side': 'top', 'sticky': ''})
                             ]})])
            except:
                # Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ®ØµÙŠØµ Ø§Ù„ØªØ®Ø·ÙŠØ·ØŒ Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£
                pass

        except Exception as e:
            # ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø£ÙŠ Ø®Ø·Ø£ØŒ Ù†Ø³ØªÙ…Ø± Ø¨Ø¯ÙˆÙ† ØªØ®ØµÙŠØµ Ø§Ù„Ø£Ù†Ù…Ø§Ø·
            print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù†Ù…Ø§Ø·: {e}")

    def _create_header(self):
        """Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù†Ù‡Ø§Ø¦ÙŠÙ‘Ù‹Ø§."""
        return  # Ù…Ø§ Ù†Ø±Ø³Ù… Ø£ÙŠ Ø¥Ø·Ø§Ø± Ø£Ùˆ Ø£Ø²Ø±Ø§Ø±

    def _cleanup_window(self, window):
        """ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©"""
        try:
            # Ø¥Ù„ØºØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©
            for after_id in window.tk.call('after', 'info'):
                window.after_cancel(after_id)

            # ØªØ¯Ù…ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ±Ø¹ÙŠØ©
            for widget in window.winfo_children():
                widget.destroy()

            # ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù†Ø§ÙØ°Ø©
            window.destroy()

            # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¬Ø§Ù…Ø¹ Ø§Ù„Ù‚Ù…Ø§Ù…Ø©
            import gc
            gc.collect()

        except:
            pass

    def _create_tab_control(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª"""
        # Ø¥Ø·Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        tab_frame = tk.Frame(self, bg=self.COLORS["background"])
        tab_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        self.tab_control = ttk.Notebook(tab_frame, style="Bold.TNotebook")
        self.tab_control.pack(fill=tk.BOTH, expand=True)

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        self._create_home_tab()
        self._create_teachers_tab()
        self._create_courses_tab()
        self._create_archive_tab()
        if self.current_user and self.current_user["permissions"]["is_admin"]:
            self._create_users_tab()
        self._create_settings_tab()

    def _create_footer(self):
        """Ø´Ø±ÙŠØ· Ø³ÙÙ„ÙŠ Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬"""
        footer = tk.Frame(self, bg="#2c3e50", height=50)
        footer.pack(side=tk.BOTTOM, fill=tk.X)
        footer.pack_propagate(False)

        # Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù†Ø¸Ø§Ù…
        left_frame = tk.Frame(footer, bg="#2c3e50")
        left_frame.pack(side=tk.LEFT, padx=20, pady=8)

        # Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_icon = tk.Label(
            left_frame,
            text="ğŸ‘¤",
            font=("Arial", 16),
            bg="#2c3e50",
            fg="white"
        )
        user_icon.pack(side=tk.LEFT, padx=(0, 10))

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        user_name = tk.Label(
            left_frame,
            text=f"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {self.current_user['full_name']}" if self.current_user else "ØºÙŠØ± Ù…Ø¹Ø±Ù",
            font=self.FONTS["text_bold"],
            bg="#2c3e50",
            fg="white"
        )
        user_name.pack(side=tk.LEFT)

        # Ø§Ù„ÙˆØ³Ø· - Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        center_frame = tk.Frame(footer, bg="#2c3e50")
        center_frame.pack(side=tk.LEFT, expand=True, padx=20)

        status_text = tk.Label(
            center_frame,
            text="Ø´Ø¤ÙˆÙ† Ø§Ù„ØªØ¯Ø±ÙŠØ¨",
            font=self.FONTS["title"],
            bg="#2c3e50",
            fg="white"
        )
        status_text.pack(side=tk.LEFT)

        # Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù† - Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
        right_frame = tk.Frame(footer, bg="#2c3e50")
        right_frame.pack(side=tk.RIGHT, padx=20, pady=8)

        # Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        logout_btn = tk.Button(
            right_frame,
            text="âš¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬",
            font=self.FONTS["text_bold"],
            bg="#e74c3c",
            fg="white",
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            padx=20,
            pady=8,
            command=self._logout
        )
        logout_btn.pack(side=tk.RIGHT)

        # ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬
        def on_enter(e):
            logout_btn['bg'] = '#c0392b'

        def on_leave(e):
            logout_btn['bg'] = '#e74c3c'

        logout_btn.bind("<Enter>", on_enter)
        logout_btn.bind("<Leave>", on_leave)
